function form_hybrid_shortcode() {
  ob_start();
  ?>
 <style>
.form-step {
  display: none;
}
.form-step.active {
  display: block;
}
.form-pagination {
  margin-top: 20px;
  display: flex;
  justify-content: space-between;
  font-famil  <div id="form-result" style="margin-top:20px; color:green;"></div>
</form>

<!-- Page de remerciement (cach√©e par d√©faut) -->
<div id="thank-you-page" style="display:none; text-align:center; background:#f8f9fa; padding:40px 20px; border-radius:12px; margin:20px 0;">
  <div style="background:#fff; max-width:600px; margin:0 auto; padding:40px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);">
    <div style="margin-bottom:30px;">
      <span style="color:#22C55E; font-size:48px;">‚úì</span>
    </div>
    <h2 style="color:#1f2937; margin-bottom:20px; font-size:32px; font-weight:700;">Formulaire envoy√© avec succ√®s</h2>
    
    <div id="reservation-number" style="background:#f3f4f6; border:2px solid #22C55E; border-radius:8px; padding:20px; margin:30px 0;">
      <p style="margin:0; font-size:18px; color:#374151; font-weight:600;">R√©servation n¬∞</p>
      <p id="order-number-display" style="margin:10px 0 0 0; font-size:24px; color:#1f2937; font-weight:700;"></p>
    </div>
    
    <p style="color:#6b7280; font-size:16px; margin:30px 0; line-height:1.6;">
      Merci de noter votre num√©ro de r√©servation sur le carton d'envoi de votre suspension<br>
      <span style="font-size:14px;">(le num√©ro est √©galement not√© dans votre mail de confirmation de r√©servation)</span>
    </p>
    
    <button id="nouvelle-demande-btn" style="
      background:#1f2937; 
      color:#fff; 
      border:none; 
      padding:15px 30px; 
      border-radius:8px; 
      font-size:16px; 
      font-weight:600; 
      cursor:pointer; 
      transition:background 0.3s;
      font-family:'din-next-lt-pro', sans-serif;
    " onmouseover="this.style.background='#374151'" onmouseout="this.style.background='#1f2937'">
      NOUVELLE DEMANDE
    </button>
  </div>
</div>

<script>'din-next-lt-pro', sans-serif;
}
.radio-group {
  margin-bottom: 18px;
  display: flex;
  gap: 18px;
  flex-wrap: wrap;
}
.progress-bar-container {
  width: 100%;
  background: #fff;
  border-radius: 3px;
  height: 7px;
  margin: 18px 0 24px 0;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.progress-bar {
  height: 100%;
  background: #FF3F22;
  border-radius: 3px;
  transition: width 0.3s;
  width: 0%;
}
.radio-btn {
  display: inline-block;
  border: 2px solid #222;
  border-radius: 10px;
  background: #fff;
  color: #222;
  font-weight: 600;
  font-size: 1rem;
  padding: 12px 24px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s, border 0.2s;
  box-shadow: none;
  outline: none;
  font-family: 'din-next-lt-pro', sans-serif;
}
.radio-btn input[type="radio"], .radio-btn input[type="checkbox"] {
  display: none;
}
.radio-btn.selected {
  background: #222;
  color: #fff;
  border-color: #222;
}
.button-disabled {
  background: #ccc !important;
  color: #888 !important;
  cursor: not-allowed !important;
  pointer-events: none;
}
</style>
<?php if (is_user_logged_in()) : ?>
<?php 
// V√©rification de l'adresse utilisateur
$user_id = get_current_user_id();
$adresse_ligne1 = get_user_meta($user_id, 'billing_address_1', true);
$ville = get_user_meta($user_id, 'billing_city', true);
$code_postal = get_user_meta($user_id, 'billing_postcode', true);
$pays = get_user_meta($user_id, 'billing_country', true);

// Si aucune adresse compl√®te n'est renseign√©e
if (empty($adresse_ligne1) || empty($ville) || empty($code_postal) || empty($pays)) : ?>
<div style="text-align:center; margin:40px 0; background:#fff3cd; border:1px solid #ffeaa7; border-radius:8px; padding:30px;">
  <h3 style="color:#856404; margin-bottom:15px;">üìç Adresse de livraison requise</h3>
  <p style="font-size:1.1em; color:#856404; margin-bottom:20px;">
    Pour utiliser nos services de r√©paration, nous avons besoin de votre adresse compl√®te pour l'exp√©dition et la facturation.
  </p>
  <a href="https://doc-headshok.com/mon-compte/" 
     style="background:#FF3F22;color:#fff;padding:15px 30px;border-radius:8px;font-weight:600;text-decoration:none;display:inline-block;font-size:1.1em;">
    üìù Compl√©ter mon adresse
  </a>
  <p style="font-size:0.9em; color:#6c757d; margin-top:15px;">
    Une fois votre adresse renseign√©e, vous pourrez acc√©der √† tous nos formulaires de demande de prestation.
  </p>
</div>
<?php else : ?>

<form id="multi-step-form">
  <div style="margin-bottom:8px;">
    <span style="font-weight:600;">√âtape <span id="progress-step">1</span>/7</span>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>
  
  <!-- √âtape 1 : Type de fourche -->
  <div class="form-step active" id="step-1">
    <h3>Quel est le mod√®le de votre fourche ?</h3>
    <div class="radio-group">
      <label class="radio-btn"><input type="radio" name="type_fourche" value="Hybrid 1/2" required> Hybrid 1/2</label>
      <label class="radio-btn"><input type="radio" name="type_fourche" value="Super Max"> Super Max</label>
      <label class="radio-btn"><input type="radio" name="type_fourche" value="Olaf"> Olaf</label>
    </div>
    <div class="form-pagination">
      <span></span>
      <button type="button" id="next-1" class="button-disabled" disabled>Suivant</button>
    </div>
  </div>

  <!-- √âtape 2 : Prestations -->
  <div class="form-step" id="step-2">
    <h3>Quelles prestations souhaitez-vous ?</h3>
    <div class="radio-group">
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="R√©vision 100 heures"> R√©vision 100 heures</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="R√©vision 200 heures"> R√©vision 200 heures</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="R√©vision Full Package"> R√©vision Full Package</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Optimisation syst√®me Headshok"> Optimisation syst√®me Headshok</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="R√©fection syst√®me Headshok"> R√©fection syst√®me Headshok</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Remplacement filet rapport√© (h√©licoil)"> Remplacement filet rapport√© (h√©licoil)</label>
    </div>
    <div class="form-pagination">
      <button type="button" id="prev-2">Pr√©c√©dent</button>
      <button type="button" id="next-2" class="button-disabled" disabled>Suivant</button>
    </div>
  </div>

  <!-- √âtape 3 : Type de prestation -->
  <div class="form-step" id="step-3">
    <h3>Quel type de prestation souhaitez-vous ?</h3>
    <div class="radio-group">
      <label class="radio-btn"><input type="radio" name="type_prestation" value="Express 24H-48H ouvr√©s"> Express 24H-48H ouvr√©s (+25‚Ç¨)</label>
      <label class="radio-btn"><input type="radio" name="type_prestation" value="Normal 5 √† 7 jours"> Normal 5 √† 7 jours (sans frais)</label>
    </div>
    <div class="form-pagination">
      <button type="button" id="prev-3">Pr√©c√©dent</button>
      <button type="button" id="next-3" class="button-disabled" disabled>Suivant</button>
    </div>
  </div>

  <!-- √âtape 4 : Options -->
  <div class="form-step" id="step-4">
    <h3>Souhaitez-vous des options suppl√©mentaires ?</h3>
    <div class="radio-group">
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Tuning hydraulique"> Tuning hydraulique (+19‚Ç¨)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Le tuning hydraulique est une modification des clapets des fourches de v√©lo qui est crucial pour optimiser les performances de la suspension avant, offrant ainsi une meilleure exp√©rience de conduite, une meilleure traction, et un meilleur contr√¥le sur divers terrains. </span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Blocage sur cintre"> Blocage sur cintre (+175‚Ç¨)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Remplacement du levier de blocage par une manette de blocage au niveau du cintre.
Permet une meilleure accessibilit√©, une manipulation plus ais√©e car gain de temps et √©conomie d‚Äôenergie dans des situations comp√©titives ou lors de sorties avec des parcours techniques.</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Modification du d√©battement"> Modification du d√©battement (+10‚Ç¨)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Permet d‚Äôavoir un plus grand d√©battement pour une conduite plus confortable et absorbante des chocs.

Sa modification peut influencer les performances : une meilleure stabitlit√© et une meileure maniabilit√©.</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Fourreau carbone"> Fourreau carbone (+499‚Ç¨/offert en r√©vision 200h)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Remplacement du fourreau aluminium par un fourreau carbone

Il permet :

‚Äì une r√©duction de poids (-320 grammes) qui all√®gue le v√©lo et offre une meilleure vivacit√© 

‚Äì une meilleure absorption des vibrations qui am√©liorera le contr√¥le et le confort de conduite

‚Äì meilleure rigidit√© qui am√©liore la direction et la r√©activit√© du v√©lo</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Sans option"> Sans option
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Aucune option suppl√©mentaire s√©lectionn√©e.</span>
        </span>
      </label>
  <div id="prix-total-step3" style="margin:18px 0;font-weight:600;font-size:1.1em;color:#FF3F22;"></div>

    </div>
    <div class="form-pagination">
      <button type="button" id="prev-4">Pr√©c√©dent</button>
      <button type="button" id="next-4" class="button-disabled" disabled>Suivant</button>
    </div>
  </div>

  <!-- √âtape 5 : Pratique -->
  <div class="form-step" id="step-5">
    <h3>Quelle est votre pratique principale ?</h3>
    <div class="radio-group">
      <label class="radio-btn"><input type="radio" name="pratique" value="XC comp√©tition"> XC comp√©tition</label>
      <label class="radio-btn"><input type="radio" name="pratique" value="XC rando"> XC rando</label>
      <label class="radio-btn"><input type="radio" name="pratique" value="Marathon"> Marathon</label>
      <label class="radio-btn"><input type="radio" name="pratique" value="Gravel"> Gravel</label>
      <label class="radio-btn"><input type="radio" name="pratique" value="Autres"> Autres</label>
    </div>
    <div class="form-pagination">
      <button type="button" id="prev-5">Pr√©c√©dent</button>
      <button type="button" id="next-5" class="button-disabled" disabled>Suivant</button>
    </div>
  </div>

  <!-- √âtape 6 : Sympt√¥mes -->
  <div class="form-step" id="step-6">
    <h3>Quels sympt√¥mes rencontrez-vous ?</h3>
    <div class="radio-group">
      <label class="radio-btn"><input type="checkbox" name="symptomes[]" value="Fuite d'huile"> Fuite d'huile</label>
      <label class="radio-btn"><input type="checkbox" name="symptomes[]" value="Jeu"> Jeu</label>
      <label class="radio-btn"><input type="checkbox" name="symptomes[]" value="Perte d'air en statique"> Perte d'air en statique</label>
      <label class="radio-btn"><input type="checkbox" name="symptomes[]" value="Perte d'air √† l'utilisation"> Perte d'air √† l'utilisation</label>
      <label class="radio-btn"><input type="checkbox" name="symptomes[]" value="Claquement"> Claquement</label>
      <label class="radio-btn"><input type="checkbox" name="symptomes[]" value="Aucun sympt√¥me"> Aucun sympt√¥me</label>
    </div>
    <div class="form-pagination">
      <button type="button" id="prev-6">Pr√©c√©dent</button>
      <button type="button" id="next-6">Suivant</button>
    </div>
  </div>

  <!-- √âtape 7 : Informations personnelles -->
  <div class="form-step" id="step-7">
    <h3>Informations compl√©mentaires</h3>
    <div style="margin-bottom:18px;">
      <label for="date-revision" style="font-weight:600;display:block;margin-bottom:6px;">Date de la derni√®re r√©vision</label>
      <input type="date" id="date-revision" name="date_revision" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:320px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="poids-pilote" style="font-weight:600;display:block;margin-bottom:6px;">Poids du pilote (kg)</label>
      <input type="number" id="poids-pilote" name="poids_pilote" min="0" step="1" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:180px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="modele-velo" style="font-weight:600;display:block;margin-bottom:6px;">Mod√®le du v√©lo</label>
      <input type="text" id="modele-velo" name="modele" required style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:250px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="annee-velo" style="font-weight:600;display:block;margin-bottom:6px;">Ann√©e du v√©lo</label>
      <input type="number" id="annee-velo" name="annee" min="1900" max="2100" step="1" required style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:120px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="remarques" style="font-weight:600;display:block;margin-bottom:6px;">Remarques</label>
      <textarea id="remarques" name="remarques" rows="3" style="width:100%;max-width:420px;padding:8px 12px;border-radius:6px;border:1px solid #ccc;"></textarea>
    </div>
    <div style="margin-bottom:18px;">
      <label for="fichier" style="font-weight:600;display:block;margin-bottom:6px;">Joindre un document</label>
      <input type="file" id="fichier" name="fichier" style="padding:8px 0;">
      <input type="hidden" name="url" value="<?php echo home_url( add_query_arg( null, null ) ); ?>">
    </div>
    <div class="form-pagination">
      <button type="button" id="prev-7">Pr√©c√©dent</button>
      <button type="button" id="next-7" class="button-disabled" disabled>Voir le r√©sum√©</button>
    </div>
  </div>

  <!-- √âtape 8 : R√©sum√© -->
  <div class="form-step" id="step-8">
    <h3>R√©sum√© de votre demande</h3>
    <div id="resume-content" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; line-height: 1.6;"></div>
    <div class="form-pagination">
      <button type="button" id="prev-8">Pr√©c√©dent</button>
      <button type="submit">Envoyer</button>
    </div>
  </div>
<div id="form-result" style="margin-top:20px; color:green;"></div>
</form>

<!-- Page de remerciement (cach√©e par d√©faut) -->
<div id="thank-you-page" style="display:none; text-align:center; background:#f8f9fa; padding:40px 20px; border-radius:12px; margin:20px 0;">
  <div style="background:#fff; max-width:600px; margin:0 auto; padding:40px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);">
    <div style="margin-bottom:30px;">
      <span style="color:#22C55E; font-size:48px;">‚úì</span>
    </div>
    <h2 style="color:#1f2937; margin-bottom:20px; font-size:32px; font-weight:700;">Formulaire envoy√© avec succ√®s</h2>
    
    <div id="reservation-number" style="background:#f3f4f6; border:2px solid #22C55E; border-radius:8px; padding:20px; margin:30px 0;">
      <p style="margin:0; font-size:18px; color:#374151; font-weight:600;">R√©servation n¬∞</p>
      <p id="order-number-display" style="margin:10px 0 0 0; font-size:24px; color:#1f2937; font-weight:700;"></p>
    </div>
    
    <p style="color:#6b7280; font-size:16px; margin:30px 0; line-height:1.6;">
      Merci de noter votre num√©ro de r√©servation sur le carton d'envoi de votre suspension<br>
      <span style="font-size:14px;">(le num√©ro est √©galement not√© dans votre mail de confirmation de r√©servation)</span>
    </p>
    
    <button id="nouvelle-demande-btn" style="
      background:#1f2937; 
      color:#fff; 
      border:none; 
      padding:15px 30px; 
      border-radius:8px; 
      font-size:16px; 
      font-weight:600; 
      cursor:pointer; 
      transition:background 0.3s;
      font-family:'din-next-lt-pro', sans-serif;
    " onmouseover="this.style.background='#374151'" onmouseout="this.style.background='#1f2937'">
      NOUVELLE DEMANDE
    </button>
  </div>
</div>

<script>
// === VARIABLES AJAX PRESTATIONS ===
<?php 
// Utiliser la fonction du functions.php
$ajax_vars = get_ajax_prestations_vars();
?>
window.ajax_object = window.ajax_object || {
    ajax_url: '<?php echo esc_js($ajax_vars['ajax_url']); ?>',
    nonce: '<?php echo esc_js($ajax_vars['nonce']); ?>',
    user_logged_in: <?php echo $ajax_vars['user_logged_in'] ? 'true' : 'false'; ?>
};

// Fonction pour afficher la page de remerciement
function showThankYouPage(numeroCommande) {
    document.getElementById('dynamic-form').style.display = 'none';
    document.getElementById('thank-you-page').style.display = 'block';
    document.getElementById('order-number-display').textContent = numeroCommande;
}

// === FONCTION SYNCHRONISATION ===
function synchroniserPrestation(formData, typePrestation, numeroSuivi = '') {
    if (!window.ajax_object.user_logged_in) {
        console.log('üë§ Utilisateur non connect√©, synchronisation ignor√©e');
        return Promise.resolve();
    }

    const modele = formData.get('modele') || '';
    const annee = formData.get('annee') || '';
    const prestations = formData.getAll('prestations[]').join(', ');
    const typePresta = formData.get('type_prestation') || '';
    const pratique = formData.get('pratique') || '';
    const symptomes = formData.getAll('symptomes[]').join(', ');
    const type_fourche = document.querySelector('input[name="type_fourche"]:checked')?.value || '';
    
    const prestationData = {
        action: 'sauvegarder_prestation_ajax',
        nonce: window.ajax_object.nonce,
        type_prestation: typePrestation,
        type_fourche: type_fourche,
        modele_velo: modele,
        annee_velo: annee,
        description: `${typePrestation} - ${prestations} (${typePresta}) - Pratique: ${pratique} - Sympt√¥mes: ${symptomes} - ${modele} (${annee})`,
        prix_total: formData.get('prix_total') || '0',
        numero_suivi: numeroSuivi, // Utiliser le num√©ro de commande re√ßu
        statut: 'attente'
    };

    console.log('üîÑ Envoi synchronisation:', prestationData);

return fetch(window.ajax_object.ajax_url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
        body: new URLSearchParams(prestationData)
    })
    .then(response => {
        console.log('üì° R√©ponse HTTP:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('üìÑ Donn√©es re√ßues:', data);
        if (data.success) {
            console.log('‚úÖ Prestation synchronis√©e:', typePrestation);
            // Afficher le num√©ro de suivi dans le r√©sum√© si disponible
            if (numeroSuivi) {
                const resumeContent = document.getElementById('resume-content');
                if (resumeContent) {
                    const numeroSuiviHTML = `<div style="background:#f0f8ff;border:2px solid #4CAF50;border-radius:8px;padding:15px;margin:15px 0;text-align:center;">
                        <strong style="color:#2E7D32;font-size:16px;">‚úÖ Demande enregistr√©e avec succ√®s !</strong><br>
                        <span style="color:#FF3F22;font-weight:bold;font-size:18px;">Num√©ro de suivi : ${numeroSuivi}</span><br>
                        <small style="color:#666;">Conservez ce num√©ro pour suivre votre demande</small>
                    </div>`;
                    resumeContent.innerHTML += numeroSuiviHTML;
                }
            }
        } else {
            console.error('‚ùå Erreur synchronisation:', data);
        }
        return data;
    })
    .catch(error => {
        console.error('‚ùå Erreur r√©seau:', error);
    });
}

// === GESTION DE LA NAVIGATION ===
let currentStep = 0;
function showStep(step) {
  const steps = document.querySelectorAll('.form-step');
  steps.forEach((stepElement, index) => {
    if (index === step) {
      stepElement.classList.add('active');
    } else {
      stepElement.classList.remove('active');
    }
  });
  updateProgressBar(step);
  updateRadioSelected();
  
  // Mise √† jour du num√©ro d'√©tape affich√©
  document.getElementById('progress-step').textContent = step + 1;
}

function updateProgressBar(step) {
  const progress = ((step + 1) / 8) * 100;
  document.querySelector('.progress-bar').style.width = progress + '%';
}

// === GESTION DES STYLES RADIO/CHECKBOX ===
function updateRadioSelected() {
  document.querySelectorAll('.radio-btn').forEach(btn => {
    const input = btn.querySelector('input[type="radio"], input[type="checkbox"]');
    if (input && input.checked) {
      btn.classList.add('selected');
    } else {
      btn.classList.remove('selected');
    }
  });
}

// === GESTION DES BOUTONS ===
function updateNextButtonState(stepId, inputName, buttonId) {
  const nextBtn = document.getElementById(buttonId);
  const step = document.getElementById(stepId);
  const input = step.querySelector(`input[name="${inputName}"]:checked`);
  
  if (input) {
    nextBtn.classList.remove('button-disabled');
    nextBtn.disabled = false;
  } else {
    nextBtn.classList.add('button-disabled');
    nextBtn.disabled = true;
  }
}

// Prix des prestations et options
const prixPrestations = {
  'R√©vision 100 heures': 129,
  'R√©vision 200 heures': 239,
  'R√©vision Full Package': 279,
  'Optimisation syst√®me Headshok': 89,
  'R√©fection syst√®me Headshok': 155,
  'Remplacement filet rapport√© (h√©licoil)': 17.50
};
const prixOptions = {
  'Tuning hydraulique': 19,
  'Blocage sur cintre': 175,
  'Modification du d√©battement': 10,
  'Fourreau carbone': 499,
  'Sans option': 0
};

const prixTypePrestation = {
  "Normal 5 √† 7 jours": 0,
  "Express 24H-48H ouvr√©s": 25
};

function calculerTotal() {
  let total = 0;
  
  // Prestations
  const prestationsCheckees = [];
  document.querySelectorAll('input[name="prestations[]"]:checked').forEach(cb => {
    prestationsCheckees.push(cb.value);
    total += prixPrestations[cb.value] || 0;
  });
  
  // Options avec logique sp√©ciale pour Fourreau carbone
  document.querySelectorAll('input[name="usage[]"]:checked').forEach(cb => {
    if (cb.value === 'Fourreau carbone') {
      // Gratuit si R√©vision 200 heures est s√©lectionn√©e
      total += prestationsCheckees.includes('R√©vision 200 heures') ? 0 : (prixOptions[cb.value] || 0);
    } else {
      total += prixOptions[cb.value] || 0;
    }
  });
  
  // Type de prestation (Express)
  const typePrestation = document.querySelector('input[name="type_prestation"]:checked');
  if (typePrestation) {
    total += prixTypePrestation[typePrestation.value] || 0;
  }
  
  return total;
}

function afficherTotalStep4() {
  const total = calculerTotal();
  document.getElementById('prix-total-step3').textContent = `Total estim√© : ${total} ‚Ç¨`;
}

// === VALIDATION FUNCTIONS ===
function updateNext2ButtonState() {
  const checkboxes = document.querySelectorAll('input[name="prestations[]"]');
  const nextBtn = document.getElementById('next-2');
  let checked = false;
  checkboxes.forEach(cb => { if(cb.checked) checked = true; });
  if (checked) {
    nextBtn.classList.remove('button-disabled');
    nextBtn.disabled = false;
  } else {
    nextBtn.classList.add('button-disabled');
    nextBtn.disabled = true;
  }
}

function updateNext3ButtonState() {
  const typePrestation = document.querySelector('input[name="type_prestation"]:checked');
  const nextBtn = document.getElementById('next-3');
  if (typePrestation) {
    nextBtn.classList.remove('button-disabled');
    nextBtn.disabled = false;
  } else {
    nextBtn.classList.add('button-disabled');
    nextBtn.disabled = true;
  }
}

function updateNext4ButtonState() {
  const checkboxes = document.querySelectorAll('input[name="usage[]"]');
  const nextBtn = document.getElementById('next-4');
  let checked = false;
  checkboxes.forEach(cb => { if(cb.checked) checked = true; });
  if (checked) {
    nextBtn.classList.remove('button-disabled');
    nextBtn.disabled = false;
  } else {
    nextBtn.classList.add('button-disabled');
    nextBtn.disabled = true;
  }
}

function updateNext5ButtonState() {
  const pratique = document.querySelector('input[name="pratique"]:checked');
  const nextBtn = document.getElementById('next-5');
  if (pratique) {
    nextBtn.classList.remove('button-disabled');
    nextBtn.disabled = false;
  } else {
    nextBtn.classList.add('button-disabled');
    nextBtn.disabled = true;
  }
}

function updateNext6ButtonState() {
  const checkboxes = document.querySelectorAll('input[name="symptomes[]"]');
  const nextBtn = document.getElementById('next-6');
  let checked = false;
  checkboxes.forEach(cb => { if(cb.checked) checked = true; });
  if (checked) {
    nextBtn.classList.remove('button-disabled');
    nextBtn.disabled = false;
  } else {
    nextBtn.classList.add('button-disabled');
    nextBtn.disabled = true;
  }
}

function updateNext7ButtonState() {
  const dateVal = document.getElementById('date-revision').value;
  const poidsVal = document.getElementById('poids-pilote').value;
  const modeleVal = document.getElementById('modele-velo').value;
  const anneeVal = document.getElementById('annee-velo').value;
  const nextBtn = document.getElementById('next-7');
  
  if(dateVal && poidsVal && modeleVal && anneeVal) {
    nextBtn.classList.remove('button-disabled');
    nextBtn.disabled = false;
  } else {
    nextBtn.classList.add('button-disabled');
    nextBtn.disabled = true;
  }
}

// === EVENT LISTENERS ===
document.addEventListener('DOMContentLoaded', function() {
  // Gestion des tooltips
  document.querySelectorAll('.tooltip-toggle').forEach(toggle => {
    const dialogue = toggle.nextElementSibling;
    toggle.addEventListener('mouseenter', function() {
      dialogue.style.display = 'block';
    });
    toggle.addEventListener('mouseleave', function() {
      dialogue.style.display = 'none';
    });
    toggle.addEventListener('focus', function() {
      dialogue.style.display = 'block';
    });
    toggle.addEventListener('blur', function() {
      dialogue.style.display = 'none';
    });
  });

  // Validation initiale
  updateNextButtonState('step-1', 'type_fourche', 'next-1');
  updateNext2ButtonState();
  updateNext3ButtonState();
  updateNext4ButtonState();
  updateNext5ButtonState();
  updateNext6ButtonState();
  updateNext7ButtonState();
  updateRadioSelected();
  updateProgressBar(0);
  afficherTotalStep4();
  
  // Event listeners pour validation
  document.querySelectorAll('input[name="type_fourche"]').forEach(input => {
    input.addEventListener('change', () => updateNextButtonState('step-1', 'type_fourche', 'next-1'));
  });
  
  document.querySelectorAll('input[name="prestations[]"]').forEach(cb => {
    cb.addEventListener('change', () => {
      updateNext2ButtonState();
      afficherTotalStep4();
    });
  });
  
  document.querySelectorAll('input[name="type_prestation"]').forEach(cb => {
    cb.addEventListener('change', () => {
      updateNext3ButtonState();
      afficherTotalStep4();
    });
  });
  
  document.querySelectorAll('input[name="usage[]"]').forEach(cb => {
    cb.addEventListener('change', () => {
      updateNext4ButtonState();
      afficherTotalStep4();
    });
  });
  
  document.querySelectorAll('input[name="pratique"]').forEach(cb => {
    cb.addEventListener('change', updateNext5ButtonState);
  });
  
  document.querySelectorAll('input[name="symptomes[]"]').forEach(cb => {
    cb.addEventListener('change', updateNext6ButtonState);
  });
  
  ['date-revision','poids-pilote','modele-velo','annee-velo'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateNext7ButtonState);
  });
  
  // Event listeners pour style radio/checkbox
  document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
    input.addEventListener('change', updateRadioSelected);
  });

  // === NAVIGATION BUTTONS ===
  document.getElementById('next-1').onclick = function() {
    if(document.querySelector('input[name="type_fourche"]:checked')) {
      currentStep = 1; 
      showStep(currentStep);
    }
  };

  document.getElementById('prev-2').onclick = function() {
    currentStep = 0; 
    showStep(currentStep);
  };

  document.getElementById('next-2').onclick = function() {
    const prestationsChecked = document.querySelectorAll('input[name="prestations[]"]:checked');
    if(prestationsChecked.length > 0) {
      currentStep = 2; 
      showStep(currentStep);
    }
  };

  document.getElementById('prev-3').onclick = function() {
    currentStep = 1;
    showStep(currentStep);
  };

  document.getElementById('next-3').onclick = function() {
    const typePrestation = document.querySelector('input[name="type_prestation"]:checked');
    if(!typePrestation) {
      document.querySelector('input[name="type_prestation"]')?.focus();
      return;
    }
    currentStep = 3;
    showStep(currentStep);
  };

  document.getElementById('prev-4').onclick = function() {
    currentStep = 2; 
    showStep(currentStep);
  };

  document.getElementById('next-4').onclick = function() {
    const checkedUsages = Array.from(document.querySelectorAll('input[name="usage[]"]:checked'));
    if(checkedUsages.length === 0) {
      document.querySelector('input[name="usage[]"]')?.focus();
      return;
    }
    currentStep = 4;
    showStep(currentStep);
  };

  document.getElementById('prev-5').onclick = function() {
    currentStep = 3; 
    showStep(currentStep);
  };

  document.getElementById('next-5').onclick = function() {
    const pratique = document.querySelector('input[name="pratique"]:checked');
    if(!pratique) {
      document.querySelector('input[name="pratique"]')?.focus();
      return;
    }
    currentStep = 5;
    showStep(currentStep);
  };

  document.getElementById('prev-6').onclick = function() {
    currentStep = 4; 
    showStep(currentStep);
  };

  document.getElementById('next-6').onclick = function() {
    const symptomes = Array.from(document.querySelectorAll('input[name="symptomes[]"]:checked'));
    if(symptomes.length === 0) {
      document.querySelector('input[name="symptomes[]"]')?.focus();
      return;
    }
    currentStep = 6;
    showStep(currentStep);
  };

  document.getElementById('prev-7').onclick = function() {
    currentStep = 5; 
    showStep(currentStep);
  };

  document.getElementById('next-7').onclick = function() {
    // Validation : tous les champs obligatoires
    const dateVal = document.getElementById('date-revision').value;
    const poidsVal = document.getElementById('poids-pilote').value;
    const modeleVal = document.getElementById('modele-velo').value;
    const anneeVal = document.getElementById('annee-velo').value;
    
    if(!dateVal || !poidsVal || !modeleVal || !anneeVal) {
      if(!dateVal) document.getElementById('date-revision').focus();
      else if(!poidsVal) document.getElementById('poids-pilote').focus();
      else if(!modeleVal) document.getElementById('modele-velo').focus();
      else if(!anneeVal) document.getElementById('annee-velo').focus();
      return;
    }
    
    // Afficher le r√©sum√©
    const type_fourche = document.querySelector('input[name="type_fourche"]:checked')?.value;
    const type_prestation = document.querySelector('input[name="type_prestation"]:checked')?.value;
    const prestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked')).map(cb => cb.value).join(', ');
    const usages = Array.from(document.querySelectorAll('input[name="usage[]"]:checked')).map(cb => cb.value).join(', ');
    const pratique = document.querySelector('input[name="pratique"]:checked')?.value;
    const symptomes = Array.from(document.querySelectorAll('input[name="symptomes[]"]:checked')).map(cb => cb.value).join(', ');
    const date_revision = document.getElementById('date-revision').value;
    const poids_pilote = document.getElementById('poids-pilote').value;
    const modele_velo = document.getElementById('modele-velo').value;
    const annee_velo = document.getElementById('annee-velo').value;
    const modele_annee = `${modele_velo} (${annee_velo})`;
    const remarques = document.getElementById('remarques').value;
    const fichier = document.getElementById('fichier').files[0];
    let fileName = fichier ? fichier.name : 'Aucun';
    
    let total = calculerTotal();
    
    let resumeContent = `<strong>Type de fourche :</strong> ${type_fourche}<br><strong>Type de prestation :</strong> ${type_prestation}<br><strong>Prestations :</strong> ${prestations}<br><strong>Options :</strong> ${usages}<br><strong>Pratique :</strong> ${pratique}<br><strong>Sympt√¥mes :</strong> ${symptomes}<br><strong>Date de la derni√®re r√©vision :</strong> ${date_revision}<br><strong>Poids du pilote :</strong> ${poids_pilote} kg<br><strong>Mod√®le du v√©lo :</strong> ${modele_velo}<br><strong>Ann√©e du v√©lo :</strong> ${annee_velo}<br><strong>Fichier joint :</strong> ${fileName}<br><span style="color:#FF3F22;font-weight:600;">Total estim√© : ${total.toLocaleString('fr-FR', {style:'currency',currency:'EUR'})} TTC</span>`;
    
    if (remarques) {
      resumeContent = resumeContent.replace('<br><strong>Fichier joint:', '<br><strong>Remarques :</strong> ' + remarques + '<br><strong>Fichier joint:');
    }
    
    document.getElementById('resume-content').innerHTML = resumeContent;
    currentStep = 7; 
    showStep(currentStep);
  };

  document.getElementById('prev-8').onclick = function() {
    currentStep = 6; 
    showStep(currentStep);
  };

  // === FORM SUBMISSION ===
  document.getElementById('multi-step-form').onsubmit = function(e) {
    e.preventDefault();
    
    const type_fourche = document.querySelector('input[name="type_fourche"]:checked')?.value;
    const type_prestation = document.querySelector('input[name="type_prestation"]:checked')?.value;
    const prestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked')).map(cb => cb.value);
    const usages = Array.from(document.querySelectorAll('input[name="usage[]"]:checked')).map(cb => cb.value);
    const pratique = document.querySelector('input[name="pratique"]:checked')?.value;
    const symptomes = Array.from(document.querySelectorAll('input[name="symptomes[]"]:checked')).map(cb => cb.value);
    const date_revision = document.getElementById('date-revision').value;
    const poids_pilote = document.getElementById('poids-pilote').value;
    const modele_velo = document.getElementById('modele-velo').value;
    const annee_velo = document.getElementById('annee-velo').value;
    const modele_annee = `${modele_velo} (${annee_velo})`;
    const remarques = document.getElementById('remarques').value;
    const fichier = document.getElementById('fichier').files[0];
    
    let prix_total = calculerTotal();
    
    var formData = new FormData();
    formData.append('type_fourche', type_fourche);
    formData.append('type_prestation', type_prestation);
    prestations.forEach(prestation => formData.append('prestations[]', prestation));
    usages.forEach(u => formData.append('usage[]', u));
    formData.append('pratique', pratique);
    symptomes.forEach(s => formData.append('symptomes[]', s));
    formData.append('date_revision', date_revision);
    formData.append('poids_pilote', poids_pilote);
    formData.append('modele', modele_velo);
    formData.append('annee', annee_velo);
    formData.append('modele_annee', modele_annee);
    formData.append('remarques', remarques);
    formData.append('prix_total', prix_total);
    if(fichier) formData.append('fichier', fichier);
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/wp-admin/admin-ajax.php?action=envoyer_form_fourche', true);
    xhr.onload = function() {
      if (xhr.status === 200) {
        let response;
        try {
          response = JSON.parse(xhr.responseText);
        } catch (e) {
          response = null;
        }
        
        let orderNumber = response && response.data && response.data.order_number ? response.data.order_number : null;
        let msg = 'Formulaire envoy√© avec succ√®s !';
        
        // Synchronisation avec l'historique
        if (typeof synchroniserPrestation !== 'undefined') {
          synchroniserPrestation(formData, 'Fourche Lefty Hybrid', orderNumber).then(prestationData => {
            if (prestationData && prestationData.success) {
              console.log('‚úÖ Prestation synchronis√©e avec num√©ro:', orderNumber);
            }
          }).catch(error => {
            console.error('Erreur lors de la synchronisation:', error);
          });
        }
        
        // Afficher la page de remerciement au lieu de reset
        if (orderNumber) {
          showThankYouPage(orderNumber);
        } else {
          // Fallback si pas de num√©ro de commande
          document.getElementById('form-result').innerHTML = msg;
          document.getElementById('form-result').style.display = 'block';
          
          // Reset du formulaire
          document.getElementById('multi-step-form').reset();
          showStep(0);
          currentStep = 0;
          updateNextButtonState('step-1', 'type_fourche', 'next-1');
          updateNext2ButtonState();
          updateNext3ButtonState();
          updateNext4ButtonState();
          updateNext5ButtonState();
          updateNext6ButtonState();
          updateNext7ButtonState();
          updateRadioSelected();
          updateProgressBar(0);
        }
        
      } else {
        document.getElementById('form-result').textContent = 'Erreur lors de l\'envoi.';
        document.getElementById('form-result').style.display = 'block';
      }
    };
    xhr.send(formData);
  };

  // Gestion du bouton "Nouvelle demande"
  const nouvelleDemandeBtn = document.getElementById('nouvelle-demande-btn');
  if (nouvelleDemandeBtn) {
      nouvelleDemandeBtn.addEventListener('click', function() {
          // Remettre √† z√©ro et afficher le formulaire
          document.getElementById('thank-you-page').style.display = 'none';
          document.getElementById('dynamic-form').style.display = 'block';
          document.getElementById('multi-step-form').reset();
          showStep(0);
          currentStep = 0;
          updateNextButtonState('step-1', 'type_fourche', 'next-1');
          updateNext2ButtonState();
          updateNext3ButtonState();
          updateNext4ButtonState();
          updateNext5ButtonState();
          updateNext6ButtonState();
          updateNext7ButtonState();
          updateRadioSelected();
          updateProgressBar(0);
      });
  }
});
</script>
<?php endif; // Fin de la v√©rification d'adresse ?>

<?php else : ?>
<div style="text-align:center; margin:40px 0;">
  <p style="font-size:1.2em; font-weight:600;">Vous devez √™tre connect√© pour acc√©der au formulaire.</p>
  <a href="https://doc-headshok.com/login/" class="button" style="background:#FF3F22;color:#fff;padding:12px 32px;border-radius:8px;font-weight:600;text-decoration:none;">Se connecter</a>
</div>
<?php endif; ?>

<?php
  return ob_get_clean();
}
add_shortcode('form_hybrid', 'form_hybrid_shortcode');
?>