 function form_lefty_shortcode() {
  ob_start();
  ?>
 <style>
.form-step {
  display: none;
}
.form-step.active {
  display: block;
}
.form-pagination {
  margin-top: 20px;
  display: flex;
  justify-content: space-between;
}
.radio-group {
  margin-bottom: 18px;
  display: flex;
  gap: 18px;
  flex-wrap: wrap;
}
.progress-bar-container {
  width: 100%;
  background: #fff;
  border-radius: 3px;
  height: 7px;
  margin: 18px 0 24px 0;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.progress-bar {
  height: 100%;
  background: #FF3F22;
  border-radius: 3px;
  transition: width 0.3s;
  width: 0%;
}
.radio-btn {
  display: inline-block;
  border: 2px solid #222;
  border-radius: 10px;
  background: #fff;
  color: #222;
  font-weight: 600;
  font-size: 1rem;
  padding: 12px 24px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s, border 0.2s;
  box-shadow: none;
  outline: none;
}
.radio-btn input[type="radio"], .radio-btn input[type="checkbox"] {
  display: none;
}
.radio-btn.selected {
  background: #222;
  color: #fff;
  border-color: #222;
}
.button-disabled {
  background: #ccc !important;
  color: #888 !important;
  cursor: not-allowed !important;
  pointer-events: none;
}
</style>
<?php if (is_user_logged_in()) : ?>

<form id="multi-step-form">
  <div style="margin-bottom:8px;">
    <span style="font-weight:600;">√âtape <span id="progress-step">1</span>/4</span>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>
  <!-- √âtape 1 -->
  <div class="form-step active" id="step-1">
    <h3>Quel est le mod√®le de votre fourche ?</h3>
    <div class="radio-group">
      <label class="radio-btn"><input type="radio" name="type_fourche" value="Lefty Ocho 27,5 100mm" required> Lefty Ocho 27,5 100mm</label>
      <label class="radio-btn"><input type="radio" name="type_fourche" value="Lefty Ocho 29 100mm"> Lefty Ocho 29 100mm</label>
		<label class="radio-btn"><input type="radio" name="type_fourche" value="Lefty Ocho 29 110mm"> Lefty Ocho 29 110mm</label>
      <label class="radio-btn"><input type="radio" name="type_fourche" value="Lefty Ocho 29 120mm"> Lefty Ocho 29 120mm</label>
      <label class="radio-btn"><input type="radio" name="type_fourche" value="Lefty Oliver"> Lefty Oliver</label>
    </div>
    <div class="form-pagination">
      <span></span>
      <button type="button" id="next-1">Suivant</button>
    </div>
  </div>
  <!-- √âtape 2 -->
  <div class="form-step" id="step-2">
    <h3>Quelles prestations souhaitez-vous ?</h3>
    <div class="radio-group">
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="R√©vision 100 heures"> R√©vision 100 heures</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="R√©vision 200 heures"> R√©vision 200 heures</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="R√©vision Full Package"> R√©vision Full Package</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Optimisation syst√®me Headshok"> Optimisation syst√®me Headshok</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="R√©fection syst√®me Headshok"> R√©fection syst√®me Headshok</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Garantie Cannondale"> Garantie Cannondale</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Remplacement filet rapport√© (h√©licoil)"> Remplacement filet rapport√© (h√©licoil)</label>
    </div>
    <div class="form-pagination">
      <button type="button" id="prev-2">Pr√©c√©dent</button>
      <button type="button" id="next-2">Suivant</button>
    </div>
  </div>
  <!-- √âtape 3 -->
  <div class="form-step" id="step-3">
    <h3>Souhaitez-vous des options suppl√©mentaires ?</h3>
    <div class="radio-group">
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Tuning hydraulique"> Tuning hydraulique (+59‚Ç¨)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Le tuning hydraulique est une modification des clapets des fourches de v√©lo qui est crucial pour optimiser les performances de la suspension avant, offrant ainsi une meilleure exp√©rience de conduite, une meilleure traction, et un meilleur contr√¥le sur divers terrains. </span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Tuning Team CFR joints spi SKF"> Tuning Team CFR joints spi SKF (+19,90‚Ç¨)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Roulez comme les pros gr√¢ce aux joints spi SKF verts.
Tuning utilis√© par la Team Cannondale Factory Racing.

Ce tuning vous permet la r√©duction des frictions et donc une meilleure sensibilit√© de la fourche et un fonctionnement plus fluide.

Il offre une meilleure √©tanch√©it√© pr√©servant ainsi l‚Äôhuile et les joints internes.

La conception SKF permet une usure plus homog√®ne, prolongeant la dur√©e de vie des joints et r√©duisant la n√©cessit√© d‚Äôentretien fr√©quent.</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Modification sens du blocage"> Modification sens du blocage (+78‚Ç¨)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">La modification du sens de blocage permet de modifier la position bloqu√©e de votre fourche.

si elle est ¬´ ferm√©e par d√©faut¬´  au repos, on passe √† une position ¬´ ouvert par d√©faut¬´  au repos, gr√¢ce au changement du clapet de blocage qui se trouve √† l‚Äôint√©rieur du piston de compression.

En terme de pr√©vention, il est utile de passer par ce syst√®me car en cas de casse de votre manette de blocage, votre fourche sera toujours utilisable pour finir votre sortie ou votre course. 

Il n‚Äôest pas possible de faire cette modification sur les Scalpel √©quip√©s de doubles commandes.</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Blocage sur cintre"> Blocage sur cintre (+157‚Ç¨)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Remplacement du levier de blocage par une manette de blocage au niveau du cintre.
Permet une meilleure accessibilit√©, une manipulation plus ais√©e car gain de temps et √©conomie d‚Äôenergie dans des situations comp√©titives ou lors de sorties avec des parcours techniques.</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Modification du d√©battement"> Modification du d√©battement (+149‚Ç¨)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Permet d‚Äôavoir un plus grand d√©battement pour une conduite plus confortable et absorbante des chocs.

Sa modification peut influencer les performances : une meilleure stabitlit√© et une meileure maniabilit√©.</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Fourreau carbone"> Fourreau carbone (+399‚Ç¨)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Remplacement du fourreau aluminium par un fourreau carbone

Il permet :

‚Äì une r√©duction de poids (-320 grammes) qui all√®gue le v√©lo et offre une meilleure vivacit√© 

‚Äì une meilleure absorption des vibrations qui am√©liorera le contr√¥le et le confort de conduite

‚Äì meilleure rigidit√© qui am√©liore la direction et la r√©activit√© du v√©lo</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Modification 650 en 700"> Modification 650 en 700 (+159‚Ç¨)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Si vous achetez une Lefty Ocho Oliver sur notre site <a href="https://110cannondale.com">110cannondale.com</a>, cette modification sera faite sans frais suppl√©mentaires. Cette modification vous permet de passer d‚Äôune Lefty Ocho Oliver pr√©vue avec une roue de 650 √† une roue de 700.

Une plus grande roue vous permet d‚Äôavoir une meilleure stabilit√©.</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Sans option"> Sans option
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Aucune option suppl√©mentaire s√©lectionn√©e.</span>
        </span>
      </label>
    <div id="prix-total-step3" style="margin:18px 0;font-weight:600;font-size:1.1em;color:#FF3F22;"></div>

    </div>
    <div class="form-pagination">
      <button type="button" id="prev-3">Pr√©c√©dent</button>
      <button type="button" id="next-3">Suivant</button>
    </div>
  </div>
  <!-- √âtape 4 : Inputs -->
  <div class="form-step" id="step-4">
    <h3>Informations compl√©mentaires</h3>
    <div style="margin-bottom:18px;">
      <label for="date-revision" style="font-weight:600;display:block;margin-bottom:6px;">Date de la derni√®re r√©vision</label>
      <input type="date" id="date-revision" name="date_revision" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:320px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="poids-pilote" style="font-weight:600;display:block;margin-bottom:6px;">Poids du pilote (kg)</label>
      <input type="number" id="poids-pilote" name="poids_pilote" min="0" step="1" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:180px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="modele-velo" style="font-weight:600;display:block;margin-bottom:6px;">Mod√®le du v√©lo</label>
      <input type="text" id="modele-velo" name="modele" required style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:250px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="annee-velo" style="font-weight:600;display:block;margin-bottom:6px;">Ann√©e du v√©lo</label>
      <input type="number" id="annee-velo" name="annee" min="1990" max="2030" step="1" required style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:120px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="remarques" style="font-weight:600;display:block;margin-bottom:6px;">Remarques</label>
      <textarea id="remarques" name="remarques" rows="3" style="width:100%;max-width:420px;padding:8px 12px;border-radius:6px;border:1px solid #ccc;"></textarea>
    </div>
    <div style="margin-bottom:18px;">
      <label for="fichier" style="font-weight:600;display:block;margin-bottom:6px;">Joindre un document</label>
      <input type="file" id="fichier" name="fichier" style="padding:8px 0;">
      <input type="hidden" name="url" value="<?php echo home_url( add_query_arg( null, null ) ); ?>">
    </div>
    <div class="form-pagination">
      <button type="button" id="prev-4">Pr√©c√©dent</button>
      <button type="button" id="next-4">Suivant</button>
    </div>
  </div>
  <!-- √âtape 5 : R√©sum√© -->
  <div class="form-step" id="step-5">
    <h3>R√©sum√© de votre demande</h3>
    <div id="resume-content" style="margin-bottom:18px;"></div>
    <div class="form-pagination">
      <button type="button" id="prev-5">Pr√©c√©dent</button>
      <button type="submit">Envoyer</button>
    </div>
  </div>
  <div id="form-result" style="margin-top:20px; color:green;"></div>
</form>
<script>
 // === VARIABLES AJAX PRESTATIONS ===
<?php 
// Utiliser la fonction du functions.php
$ajax_vars = get_ajax_prestations_vars();
?>
window.ajax_object = window.ajax_object || {
    ajax_url: '<?php echo esc_js($ajax_vars['ajax_url']); ?>',
    nonce: '<?php echo esc_js($ajax_vars['nonce']); ?>',
    user_logged_in: <?php echo $ajax_vars['user_logged_in'] ? 'true' : 'false'; ?>
};

// === FONCTION SYNCHRONISATION ===
function synchroniserPrestation(formData, typePrestation) {
    if (!window.ajax_object.user_logged_in) {
        console.log('üë§ Utilisateur non connect√©, synchronisation ignor√©e');
        return Promise.resolve();
    }

    const modele = formData.get('modele') || '';
    const annee = formData.get('annee') || '';
    const prestations = formData.getAll('prestations[]').join(', ');
    
    const prestationData = {
        action: 'sauvegarder_prestation_ajax',
        nonce: window.ajax_object.nonce,
        type_prestation: typePrestation,
        modele_velo: modele,
        annee_velo: annee,
        description: `${typePrestation} - ${prestations} demand√© pour ${modele} (${annee})`,
        statut: 'attente'
    };

    console.log('üîÑ Envoi synchronisation:', prestationData);

    return fetch(window.ajax_object.ajax_url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(prestationData)
    })
    .then(response => {
        console.log('üì° R√©ponse HTTP:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('üìÑ Donn√©es re√ßues:', data);
        if (data.success) {
            console.log('‚úÖ Prestation synchronis√©e:', typePrestation);
        } else {
            console.error('‚ùå Erreur synchronisation:', data);
        }
        return data;
    })
    .catch(error => {
        console.error('‚ùå Erreur r√©seau:', error);
    });
}
// Prix des prestations et options
const prixPrestations = {
  'R√©vision 100 heures': 129,
  'R√©vision 200 heures': 189,
  'R√©vision Full Package': 249,
  'Optimisation syst√®me Headshok': 89,
  'R√©fection syst√®me Headshok': 99,
  'Garantie Cannondale': 0,
  'Remplacement filet rapport√© (h√©licoil)': 39
};
const prixOptions = {
  'Tuning hydraulique': 59,
  'Tuning Team CFR joints spi SKF': 19.9,
  'Modification sens du blocage': 78,
  'Blocage sur cintre': 157,
  'Modification du d√©battement': 149,
  'Fourreau carbone': 399,
  'Modification 650 en 700': 159,
  'Sans option': 0
};

function calculerTotal() {
  const prestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked'));
  const options = Array.from(document.querySelectorAll('input[name="usage[]"]:checked')).map(cb => cb.value);
  let total = 0;
  
  prestations.forEach(prestation => {
    if (prixPrestations[prestation.value]) {
      total += prixPrestations[prestation.value];
    }
  });
  
  options.forEach(opt => {
    if (opt === 'Fourreau carbone') {
      // V√©rifier si "R√©vision 200 heures" est s√©lectionn√©e
      const revision200Selected = prestations.some(p => p.value === 'R√©vision 200 heures');
      total += revision200Selected ? 0 : 399;
    } else if (prixOptions[opt]) {
      total += prixOptions[opt];
    }
  });
  return total;
}

function afficherTotalStep3() {
  const total = calculerTotal();
  document.getElementById('prix-total-step3').textContent = 'Total estim√© : ' + total.toLocaleString('fr-FR', {style:'currency',currency:'EUR'}) + ' TTC';
}

// Mettre √† jour le total √† chaque changement de prestation ou option
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('input[name="prestations[]"]').forEach(function(checkbox) {
    checkbox.addEventListener('change', afficherTotalStep3);
  });
  document.querySelectorAll('input[name="usage[]"]').forEach(function(cb) {
    cb.addEventListener('change', afficherTotalStep3);
  });
  afficherTotalStep3();
});
// Info dialogue toggle
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.info-toggle').forEach(function(toggle) {
    const dialogue = toggle.querySelector('.info-dialogue');
    toggle.addEventListener('mouseenter', function() {
      dialogue.style.display = 'block';
    });
    toggle.addEventListener('mouseleave', function() {
      dialogue.style.display = 'none';
    });
    toggle.addEventListener('focus', function() {
      dialogue.style.display = 'block';
    });
    toggle.addEventListener('blur', function() {
      dialogue.style.display = 'none';
    });
  });
});
const steps = [
  document.getElementById('step-1'),
  document.getElementById('step-2'),
  document.getElementById('step-3'),
  document.getElementById('step-4'),
  document.getElementById('step-5')
];
let currentStep = 0;
function showStep(index) {
  steps.forEach((step, i) => step.classList.toggle('active', i === index));
  updateProgressBar(index);
  // Focus sur le formulaire pour le centrer √† chaque changement d'√©tape
  const form = document.getElementById('multi-step-form');
  if(form) {
    form.scrollIntoView({behavior: 'smooth', block: 'center'});
  }
}
function updateProgressBar(index) {
  // 4 √©tapes de questions, la 5e est le r√©sum√©
  const totalSteps = 4;
  let stepNum = index + 1;
  if (stepNum > totalSteps) stepNum = totalSteps;
  document.getElementById('progress-step').textContent = stepNum > totalSteps ? totalSteps : stepNum;
  const percent = Math.round((stepNum-1) / totalSteps * 100);
  document.getElementById('progress-bar').style.width = percent + '%';
}
function updateNextButtonState(step, radioName, nextBtnId) {
  const radios = document.getElementsByName(radioName);
  const nextBtn = document.getElementById(nextBtnId);
  function check() {
    let checked = false;
    radios.forEach ? radios.forEach(r => { if(r.checked) checked = true; }) : Array.from(radios).forEach(r => { if(r.checked) checked = true; });
    if (checked) {
      nextBtn.classList.remove('button-disabled');
      nextBtn.disabled = false;
    } else {
      nextBtn.classList.add('button-disabled');
      nextBtn.disabled = true;
    }
  }
  radios.forEach ? radios.forEach(r => r.addEventListener('change', check)) : Array.from(radios).forEach(r => r.addEventListener('change', check));
  check();
}
function updateNext2ButtonState() {
  const dateVal = document.getElementById('date-revision').value;
  const poidsVal = document.getElementById('poids-pilote').value;
  const modeleVal = document.getElementById('modele-velo').value;
  const anneeVal = document.getElementById('annee-velo').value;
  const remarquesVal = document.getElementById('remarques').value;
  const nextBtn = document.getElementById('next-2');
  if(dateVal && poidsVal && modeleVal && anneeVal && remarquesVal) {
    nextBtn.classList.remove('button-disabled');
    nextBtn.disabled = false;
  } else {
    nextBtn.classList.add('button-disabled');
    nextBtn.disabled = true;
  }
}
function updateRadioSelected() {
  document.querySelectorAll('.radio-group').forEach(group => {
    group.querySelectorAll('.radio-btn').forEach(label => {
      const input = label.querySelector('input[type="radio"], input[type="checkbox"]');
      if (!input) return;
      // On retire tous les listeners pr√©c√©dents pour √©viter les doublons
      input.onchange = function() {
        if(input.type === 'radio') {
          group.querySelectorAll('.radio-btn').forEach(l => l.classList.remove('selected'));
          if(input.checked) label.classList.add('selected');
        } else if(input.type === 'checkbox') {
          if(input.checked) label.classList.add('selected');
          else label.classList.remove('selected');
        }
      };
      // Mise √† jour initiale
      if(input.checked) label.classList.add('selected');
      else label.classList.remove('selected');
    });
  });
}

  // D√©sactivation dynamique des options suppl√©mentaires selon mod√®le et prestation
  function updateOptionsState() {
    // R√©cup√©rer les valeurs s√©lectionn√©es
    const prestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked')).map(cb => cb.value);
    const modele = document.querySelector('input[name="type_fourche"]:checked')?.value || '';
    // Mapping des options
    const options = {
      'Tuning hydraulique': null,
      'Tuning Team CFR joints spi SKF': null,
      'Modification sens du blocage': null,
      'Blocage sur cintre': null,
      'Modification du d√©battement': null,
      'Fourreau carbone': null,
      'Modification 650 en 700': null,
      'Sans option': null
    };
    // R√®gle 1 : D√©sactiver toutes les options sauf "Sans option" pour certaines prestations
    const prestationsSansOptions = [
      'Optimisation syst√®me Headshok',
      'R√©fection syst√®me Headshok',
      'Garantie Cannondale',
      'Remplacement filet rapport√© (h√©licoil)'
    ];
    const hasPrestationSansOptions = prestations.some(p => prestationsSansOptions.includes(p));
    if (hasPrestationSansOptions) {
      Object.keys(options).forEach(opt => {
        const cb = document.querySelector('input[name="usage[]"][value="'+opt+'"]');
        if (cb) {
          cb.disabled = (opt !== 'Sans option');
          cb.parentElement.classList.toggle('button-disabled', opt !== 'Sans option');
          // On d√©coche l'option si elle est d√©sactiv√©e
          if (cb.disabled) cb.checked = false;
        }
      });
      return;
    }
    // R√®gle 2 : D√©sactiver "Tuning CFR joints spi SKF" pour "R√©vision 100 heures"
    const cbCFR = document.querySelector('input[name="usage[]"][value="Tuning Team CFR joints spi SKF"]');
    if (cbCFR) {
      cbCFR.disabled = prestations.includes('R√©vision 100 heures');
      cbCFR.parentElement.classList.toggle('button-disabled', prestations.includes('R√©vision 100 heures'));
    }
    // R√®gle 3 : D√©sactiver "Modification 650 en 700" sauf pour mod√®le "Lefty Oliver"
    const cb650700 = document.querySelector('input[name="usage[]"][value="Modification 650 en 700"]');
    if (cb650700) {
      cb650700.disabled = (modele !== 'Lefty Oliver');
      cb650700.parentElement.classList.toggle('button-disabled', modele !== 'Lefty Oliver');
    }
    // R√®gle 4 : D√©sactiver "Blocage sur cintre" sauf pour mod√®le "Lefty Ocho 29 120mm"
    const cbBlocageCintre = document.querySelector('input[name="usage[]"][value="Blocage sur cintre"]');
    if (cbBlocageCintre) {
      cbBlocageCintre.disabled = (modele !== 'Lefty Ocho 29 120mm');
      cbBlocageCintre.parentElement.classList.toggle('button-disabled', modele !== 'Lefty Ocho 29 120mm');
    }
    // R√®gle 5 : D√©sactiver "Modification du d√©battement" sauf pour mod√®le "Lefty Ocho 29 110mm"
    const cbDebattement = document.querySelector('input[name="usage[]"][value="Modification du d√©battement"]');
    if (cbDebattement) {
      cbDebattement.disabled = (modele !== 'Lefty Ocho 29 110mm');
      cbDebattement.parentElement.classList.toggle('button-disabled', modele !== 'Lefty Ocho 29 110mm');
    }
    // R√®gle 6 : D√©sactiver "Modification sens du blocage" pour mod√®le "Lefty Oliver"
    const cbSensBlocage = document.querySelector('input[name="usage[]"][value="Modification sens du blocage"]');
    if (cbSensBlocage) {
      cbSensBlocage.disabled = (modele === 'Lefty Oliver');
      cbSensBlocage.parentElement.classList.toggle('button-disabled', modele === 'Lefty Oliver');
    }
    // R√©activer toutes les autres options
    Object.keys(options).forEach(opt => {
      if (opt === 'Sans option') return;
      const cb = document.querySelector('input[name="usage[]"][value="'+opt+'"]');
      if (cb) {
        // On r√©active si aucune r√®gle ne l'a d√©sactiv√©
        if (!cb.disabled) {
          cb.parentElement.classList.remove('button-disabled');
        }
      }
    });
  }

  // √âcouteurs sur prestation et mod√®le
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[name="prestations[]"]').forEach(function(checkbox) {
      checkbox.addEventListener('change', updateOptionsState);
    });
    document.querySelectorAll('input[name="type_fourche"]').forEach(function(radio) {
      radio.addEventListener('change', updateOptionsState);
    });
    updateOptionsState();
  });
document.addEventListener('DOMContentLoaded', function() {
  updateNextButtonState('step-1', 'type_fourche', 'next-1');
  // Pour les checkboxes de prestations, on active le bouton suivant si au moins une est coch√©e
  function updateNext2ButtonState() {
    const checkboxes = document.querySelectorAll('input[name="prestations[]"]');
    const nextBtn = document.getElementById('next-2');
    let checked = false;
    checkboxes.forEach(cb => { if(cb.checked) checked = true; });
    if (checked) {
      nextBtn.classList.remove('button-disabled');
      nextBtn.disabled = false;
    } else {
      nextBtn.classList.add('button-disabled');
      nextBtn.disabled = true;
    }
  }
  document.querySelectorAll('input[name="prestations[]"]').forEach(cb => cb.addEventListener('change', updateNext2ButtonState));
  updateNext2ButtonState();
  // Pour les checkboxes, on active le bouton suivant si au moins une est coch√©e
  function updateNext3ButtonState() {
    const checkboxes = document.querySelectorAll('input[name="usage[]"]');
    const nextBtn = document.getElementById('next-3');
    let checked = false;
    checkboxes.forEach(cb => { if(cb.checked) checked = true; });
    if (checked) {
      nextBtn.classList.remove('button-disabled');
      nextBtn.disabled = false;
    } else {
      nextBtn.classList.add('button-disabled');
      nextBtn.disabled = true;
    }
  }
  document.querySelectorAll('input[name="usage[]"]').forEach(cb => cb.addEventListener('change', updateNext3ButtonState));
  updateNext3ButtonState();
  // √âtape 4 : inputs
  function updateNext4ButtonState() {
    const dateVal = document.getElementById('date-revision').value;
    const poidsVal = document.getElementById('poids-pilote').value;
    const modeleVal = document.getElementById('modele-velo').value;
    const anneeVal = document.getElementById('annee-velo').value;
    const remarquesVal = document.getElementById('remarques').value;
    const nextBtn = document.getElementById('next-4');
    if(dateVal && poidsVal && modeleVal && anneeVal && remarquesVal) {
      nextBtn.classList.remove('button-disabled');
      nextBtn.disabled = false;
    } else {
      nextBtn.classList.add('button-disabled');
      nextBtn.disabled = true;
    }
  }
  ['date-revision','poids-pilote','modele-velo','annee-velo','remarques'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateNext4ButtonState);
  });
  updateNext4ButtonState();
  updateRadioSelected();
  updateProgressBar(0);
});
document.addEventListener('DOMContentLoaded', function() {
  updateRadioSelected();
  document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
    input.addEventListener('change', updateRadioSelected);
  });
});
document.getElementById('next-1').onclick = function() {
  if(document.querySelector('input[name="type_fourche"]:checked')) {
    currentStep = 1; showStep(currentStep);
  }
};
document.getElementById('prev-2').onclick = function() {
  currentStep = 0; showStep(currentStep);
};
document.getElementById('next-2').onclick = function() {
  const prestationsChecked = document.querySelectorAll('input[name="prestations[]"]:checked');
  if(prestationsChecked.length > 0) {
    currentStep = 2; showStep(currentStep);
  }
};
document.getElementById('prev-3').onclick = function() {
  currentStep = 1;
  showStep(currentStep);
};
document.getElementById('next-3').onclick = function() {
  const checkedUsages = Array.from(document.querySelectorAll('input[name="usage[]"]:checked'));
  if(checkedUsages.length === 0) {
    checkedUsages[0]?.focus();
    return;
  }
  currentStep = 3;
  showStep(currentStep);
};
document.getElementById('prev-4').onclick = function() {
  currentStep = 2; showStep(currentStep);
};
document.getElementById('next-4').onclick = function() {
  // Validation : tous les champs obligatoires
  const dateVal = document.getElementById('date-revision').value;
  const poidsVal = document.getElementById('poids-pilote').value;
  const modeleVal = document.getElementById('modele-velo').value;
  const anneeVal = document.getElementById('annee-velo').value;
  const remarquesVal = document.getElementById('remarques').value;
  if(!dateVal || !poidsVal || !modeleVal || !anneeVal || !remarquesVal) {
    if(!dateVal) document.getElementById('date-revision').focus();
    else if(!poidsVal) document.getElementById('poids-pilote').focus();
    else if(!modeleVal) document.getElementById('modele-velo').focus();
    else if(!anneeVal) document.getElementById('annee-velo').focus();
    else document.getElementById('remarques').focus();
    return;
  }
  // Afficher le r√©sum√©
  const type_fourche = document.querySelector('input[name="type_fourche"]:checked')?.value;
  const prestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked')).map(cb => cb.value).join(', ');
  const usages = Array.from(document.querySelectorAll('input[name="usage[]"]:checked')).map(cb => cb.value).join(', ');
  const date_revision = document.getElementById('date-revision').value;
  const poids_pilote = document.getElementById('poids-pilote').value;
  const modele_velo = document.getElementById('modele-velo').value;
  const annee_velo = document.getElementById('annee-velo').value;
  const modele_annee = `${modele_velo} (${annee_velo})`;
  const remarques = document.getElementById('remarques').value;
  const fichier = document.getElementById('fichier').files[0];
  let fileName = fichier ? fichier.name : 'Aucun';
  const total = calculerTotal();
  let resumeContent = `<strong>Type de fourche :</strong> ${type_fourche}<br><strong>Prestations :</strong> ${prestations}<br><strong>Options :</strong> ${usages}<br><strong>Date de la derni√®re r√©vision :</strong> ${date_revision}<br><strong>Poids du pilote :</strong> ${poids_pilote} kg<br><strong>Mod√®le du v√©lo :</strong> ${modele_velo}<br><strong>Ann√©e du v√©lo :</strong> ${annee_velo}<br><strong>Fichier joint :</strong> ${fileName}<br><span style="color:#FF3F22;font-weight:600;">Total estim√© : ${total.toLocaleString('fr-FR', {style:'currency',currency:'EUR'})} TTC</span>`;
  
  if (remarques) {
    resumeContent = resumeContent.replace('<br><strong>Fichier joint:', '<br><strong>Remarques :</strong> ' + remarques + '<br><strong>Fichier joint:');
  }
  
  document.getElementById('resume-content').innerHTML = resumeContent;
  currentStep = 4; showStep(currentStep);
};
document.getElementById('multi-step-form').onsubmit = function(e) {
  e.preventDefault();
  const type_fourche = document.querySelector('input[name="type_fourche"]:checked')?.value;
  const prestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked')).map(cb => cb.value);
  const usages = Array.from(document.querySelectorAll('input[name="usage[]"]:checked')).map(cb => cb.value);
  const date_revision = document.getElementById('date-revision').value;
  const poids_pilote = document.getElementById('poids-pilote').value;
  const modele_velo = document.getElementById('modele-velo').value;
  const annee_velo = document.getElementById('annee-velo').value;
  const modele_annee = `${modele_velo} (${annee_velo})`;
  const remarques = document.getElementById('remarques').value;
  const fichier = document.getElementById('fichier').files[0];
  const prix_total = calculerTotal();
  var formData = new FormData();
  formData.append('type_fourche', type_fourche);
  prestations.forEach(prestation => formData.append('prestations[]', prestation));
  usages.forEach(u => formData.append('usage[]', u));
  formData.append('date_revision', date_revision);
  formData.append('poids_pilote', poids_pilote);
  formData.append('modele', modele_velo);
  formData.append('annee', annee_velo);
  formData.append('modele_annee', modele_annee);
  formData.append('remarques', remarques);
  formData.append('prix_total', prix_total);
  if(fichier) formData.append('fichier', fichier);
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/wp-admin/admin-ajax.php?action=envoyer_form_fourche', true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      let response;
      try {
        response = JSON.parse(xhr.responseText);
      } catch (e) {
        response = null;
      }
      let orderNumber = response && response.data && response.data.order_number ? response.data.order_number : null;
      let msg = 'Formulaire envoy√© avec succ√®s !';
      if (typeof synchroniserPrestation !== 'undefined') {
        synchroniserPrestation(formData, 'Fourche Lefty Ocho');
      }
      if(orderNumber) {
        msg += `<br><span style="color:#FF3F22;font-weight:600;">Num√©ro de suivi : ${orderNumber}</span>`;
        document.getElementById('resume-content').innerHTML += `<br><strong>Num√©ro de suivi :</strong> <span style='color:#FF3F22;'>${orderNumber}</span>`;
      }
      document.getElementById('form-result').innerHTML = msg;
      document.getElementById('multi-step-form').reset();
      showStep(0);
      updateNextButtonState('step-1', 'type_fourche', 'next-1');
      updateNextButtonState('step-2', 'prestation', 'next-2');
      updateNext3ButtonState();
      updateNext4ButtonState();
      updateRadioSelected();
      updateProgressBar(0);
    } else {
      document.getElementById('form-result').textContent = 'Erreur lors de l‚Äôenvoi.';
    }
  };
  xhr.send(formData);
};
</script>
<?php else : ?>
<div style="text-align:center; margin:40px 0;">
  <p style="font-size:1.2em; font-weight:600;">Vous devez √™tre connect√© pour acc√©der au formulaire.</p>
  <a href="<?php echo wp_login_url(); ?>" class="button" style="background:#FF3F22;color:#fff;padding:12px 32px;border-radius:8px;font-weight:600;text-decoration:none;">Se connecter</a>
</div>
<?php endif; ?>


  <?php
	return ob_get_clean();
}
add_shortcode('form_lefty', 'form_lefty_shortcode');
