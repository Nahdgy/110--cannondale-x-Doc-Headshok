/*
 * Plugin Name: Shortcode formulaire réinitialisation mot de passe personnalisé
 * Description: Shortcode [mon_formulaire_reset_password] affichant un formulaire de réinitialisation de mot de passe compatible WordPress
 * Version: 1.0
 * Author: TonNom
 */

function mon_formulaire_reset_password_shortcode() {
    $message = '';
    $success = false;

    // Traitement du formulaire
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['reset_submit'])) {
        $user_login = sanitize_text_field($_POST['user_login']);
        if (empty($user_login)) {
            $message = '<p style="color:red;">Veuillez saisir votre identifiant ou adresse email.</p>';
        } else {
            $user = get_user_by('email', $user_login);
            if (!$user) {
                $user = get_user_by('login', $user_login);
            }
            if ($user) {
                // Envoie l'email de réinitialisation natif WordPress
                $reset = retrieve_password($user_login);
                if ($reset === true) {
                    $success = true;
                    $message = '<p style="color:green;">Un email de réinitialisation a été envoyé si l’adresse existe dans notre base. Pensez à vérifier vos spams.</p>';
                } else {
                    $message = '<p style="color:red;">Erreur lors de l’envoi de l’email. Veuillez réessayer.</p>';
                }
            } else {
                $message = '<p style="color:green;">Un email de réinitialisation a été envoyé si l’adresse existe dans notre base. Pensez à vérifier vos spams.</p>';
            }
        }
    }

    ob_start();
    ?>
    <style>
        .mon-form-connexion {
            max-width: 380px;
            margin: 30px auto;
            font-family: Arial, sans-serif;
            border: 1px solid #ddd;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #fff;
        }
        .mon-form-connexion h2 {
            text-align: center;
            margin-bottom: 20px;
            font-family: Helvetica, sans-serif;
            font-weight: 700;
            font-size: 35px;
            color: #000000;
        }
        .mon-form-connexion label {
            display: block;
            margin-bottom: 6px;
            font-family: 'din-next-lt-pro', sans-serif;
            font-weight: 300;
            font-size: 16px;
            color: #333;
        }
        .mon-form-connexion label .required {
            color: red;
            margin-left: 4px;
        }
        .mon-form-connexion input[type="text"],
        .mon-form-connexion input[type="email"] {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: #F7F7F7;
        }
        .mon-form-connexion button[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: #151515;
            color: #F9F9F9;
            font-family: 'din-next-lt-pro', sans-serif;
            font-size: 16px;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .mon-form-connexion button[type="submit"]:hover {
            background-color: #000000;
        }
        .mon-form-connexion .texte-retour {
            text-align: center;
            margin-top: 18px;
            font-size: 14px;
            color: #555;
        }
        .mon-form-connexion .texte-retour a {
            color: #000000;
            text-decoration: none;
            font-weight: 600;
        }
    </style>
    <div class="mon-form-connexion">
        <h2>Réinitialiser le mot de passe</h2>
        <?php echo $message; ?>
        <?php if (!$success): ?>
        <form method="post" action="">
            <label for="user_login">Identifiant ou email <span class="required">*</span></label>
            <input type="text" id="user_login" name="user_login" required placeholder="Votre identifiant ou email">
            <button type="submit" name="reset_submit">ENVOYER LE LIEN</button>
        </form>
        <?php endif; ?>
        <p class="texte-retour">
            <a href="/login">&#8592; Retour à la connexion</a>
        </p>
    </div>
    <?php
    return ob_get_clean();
}
add_shortcode('mon_formulaire_reset_password', 'mon_formulaire_reset_password_shortcode');
