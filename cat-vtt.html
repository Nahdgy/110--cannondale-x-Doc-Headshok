/**
 * Shortcode : [sous_categories_vtt]
 * Affiche les sous-catégories VTT avec filtres, tri et bouton "Voir plus"
 */

add_shortcode('sous_categories_vtt', 'afficher_sous_categories_vtt');

function afficher_sous_categories_vtt() {
  ob_start();

  $parent = get_term_by('slug', 'vtt', 'product_cat');
  // Récupération des filtres depuis l'URL (GET)
  $filtres = isset($_GET['filtre']) ? (array)$_GET['filtre'] : [];

  // Construction de la requête tax_query pour WP_Term_Query
  $tax_query = [
    [
      'taxonomy' => 'product_cat',
      'parent' => $parent ? $parent->term_id : 0,
      'hide_empty' => false,
    ]
  ];

  // Ajout des filtres contextuels (modèles, années, etc.)
  if (!empty($filtres)) {
    foreach ($filtres as $slug) {
      $tax_query[] = [
        'taxonomy' => 'product_cat',
        'field' => 'slug',
        'terms' => $slug,
      ];
    }
  }

  // Récupération des sous-catégories filtrées
  $args = [
    'taxonomy' => 'product_cat',
    'parent' => $parent ? $parent->term_id : 0,
    'hide_empty' => false,
  ];
  if (!empty($filtres)) {
    $args['slug'] = $filtres;
  }
  $sous_categories = get_terms($args);

  $html_filtres = afficher_filtres_sous_categories_vtt($filtres);

  if (!empty($sous_categories) && !is_wp_error($sous_categories)) {
    ?>
    <style>
      ul.liste-categories {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }

      @media screen and (max-width: 1023px) {
        ul.liste-categories {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media screen and (max-width: 766px) {
        ul.liste-categories {
          grid-template-columns: repeat(1, 1fr);
        }
      }

      ul.liste-categories li {
        background-color: #F7F7F7;
        border-radius: 6px;
        padding: 15px;
        box-sizing: border-box;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        min-height: 300px;
        transition: transform 0.3s ease;
      }

      ul.liste-categories li:hover {
        transform: translateY(-4px);
      }

      ul.liste-categories li a {
        color: inherit;
        text-decoration: none;
        display: block;
        width: 100%;
      }

      ul.liste-categories li img {
        max-width: 100%;
        height: auto;
        margin-bottom: 15px;
        object-fit: contain;
        max-height: 180px;
      }

      ul.liste-categories li .titre-categorie {
        font-family: 'DIN Next LT Pro', sans-serif;
        font-weight: 700;
        font-size: 18px;
        color: #000000;
        text-align: center;
        margin-top: auto;
      }

      .barre-tri {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }

      #nombre-produits {
        font-family: 'DIN Next LT Pro', sans-serif;
        font-weight: 300;
        font-size: 24px;
        color: black;
        margin-right: 2rem;
      }

      .toggle-titre {
        color: black !important;
        display: flex;
        justify-content: space-between;
        cursor: pointer;
      }

      #form-filtres {
        height: 600px;
        overflow-y: scroll;
        width: 100%;
        scrollbar-color: black #F8F8F8;
      }

      .filtre-groupe {
        margin-right: 1rem;
        min-width: 200px;
      }

      .tri-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .tri-container label {
        font-family: 'DIN Next LT Pro', sans-serif;
        font-weight: 300;
        font-size: 16px;
        color: #000;
        margin-bottom: 0;
      }

      #tri-sous-categories {
        width: 160px;
        padding: 6px 8px;
        font-family: 'DIN Next LT Pro', sans-serif;
        font-size: 14px;
      }

      .separator-red {
        border: none;
        border-bottom: 2px solid #FF3F22 !important;
        margin: 0 0 20px 0;
        width: 100%;
      }

      #filtres-appliques{
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 10px;
      }

      #voir-plus {
        background-color: #000;
        color: #fff;
        border: none;
        padding: 10px 20px;
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        margin: 20px auto 0;
        display: block;
      }
    </style>

    <div id="produits-filtrables-container" style="display:flex; flex-direction: column; gap:20px;">
      <div class="barre-tri">
        <div style="display: flex; align-items: center;">
          <div id="nombre-produits"><?php echo count($sous_categories); ?> résultats</div>
          <div id="cacher-filtres">Cacher les filtres</div>
        </div>
        <div class="tri-container">
          <label for="tri-sous-categories">Trier par :</label>
          <select id="tri-sous-categories">
            <option value="default">Tri par défaut</option>
            <option value="alpha">Ordre alphabétique A-Z</option>
            <option value="alpha-desc">Ordre alphabétique Z-A</option>
          </select>
        </div>
      </div>
      <hr class="separator-red">
      <div style="display:flex; gap:20px;">
        <div style="width:25%; min-width:170px;" id="zone-filtres">
          <?php echo $html_filtres; ?>
        </div>
        <div style="flex:1;">
          <ul class="liste-categories" id="liste-sous-categories">
            <?php foreach ($sous_categories as $index => $cat) :
              $thumbnail_id = get_term_meta($cat->term_id, 'thumbnail_id', true);
              $image_url = $thumbnail_id ? wp_get_attachment_url($thumbnail_id) : wc_placeholder_img_src('medium');
              $hidden_class = $index >= 18 ? 'style="display:none;" class="hidden-cat"' : '';
            ?>
              <li data-name="<?php echo esc_attr($cat->name); ?>" <?php echo $hidden_class; ?>>
                <a href="<?php echo esc_url('https://cannonbale.com/detail-velo/?pratique=vtt&modele=' . sanitize_title($cat->name)); ?>">
                  <img src="<?php echo esc_url($image_url); ?>" alt="<?php echo esc_attr($cat->name); ?>">
                  <div class="titre-categorie"><?php echo esc_html($cat->name); ?></div>
                </a>
              </li>
            <?php endforeach; ?>
          </ul>
          <?php if (count($sous_categories) > 18) : ?>
            <button id="voir-plus">Voir plus</button>
          <?php endif; ?>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const triSelect = document.getElementById('tri-sous-categories');
        const liste = document.getElementById('liste-sous-categories');

        triSelect.addEventListener('change', function () {
          const items = Array.from(liste.querySelectorAll('li'));
          if (this.value === 'alpha') {
            items.sort((a, b) => a.dataset.name.localeCompare(b.dataset.name));
          } else if (this.value === 'alpha-desc') {
            items.sort((a, b) => b.dataset.name.localeCompare(a.dataset.name));
          } else {
            return;
          }
          items.forEach(item => liste.appendChild(item));
        });

        document.querySelectorAll(".toggle-titre").forEach((title) => {
          title.addEventListener("click", () => {
            const section = document.getElementById(title.dataset.target);
            const arrow = title.querySelector("span");
            if (section.style.display === "none" || section.style.display === "") {
              section.style.display = "block";
              arrow.textContent = "˄";
            } else {
              section.style.display = "none";
              arrow.textContent = "˅";
            }
          });
        });

        const cacherFiltres = document.getElementById("cacher-filtres");
        cacherFiltres?.addEventListener("click", () => {
          document.querySelectorAll("#form-filtres .filtre-options").forEach(section => {
            section.style.display = "none";
          });
          document.querySelectorAll("#form-filtres .toggle-titre span").forEach(span => {
            span.textContent = " ˅";
          });
        });

        const voirPlusBtn = document.getElementById("voir-plus");
        if (voirPlusBtn) {
          voirPlusBtn.addEventListener("click", function () {
            document.querySelectorAll(".hidden-cat").forEach(el => el.style.display = "flex");
            voirPlusBtn.style.display = "none";
          });
        }
      });
    </script>
    <?php
  } else {
    echo '<p>Aucun modèle trouvé pour VTT.</p>';
  }

  return ob_get_clean();
}

function afficher_filtres_sous_categories_vtt($filtres_actuels = []) {
  $parent_vtt = get_term_by('slug', 'vtt', 'product_cat');
  $modeles = [];
  if ($parent_vtt) {
    $modeles = get_terms([
      'taxonomy' => 'product_cat',
      'parent' => $parent_vtt->term_id,
      'hide_empty' => false,
    ]);
  }

  $parent_annee = get_term_by('slug', 'annee', 'product_cat');
  $annees = [];
  if ($parent_annee) {
    $annees = get_terms([
      'taxonomy' => 'product_cat',
      'parent' => $parent_annee->term_id,
      'hide_empty' => false,
    ]);
  }

  $sections = [
    'Filtres appliqués' => [],
    'Modèles' => $modeles,
    'Années' => $annees,
  ];

  $html = '<form id="form-filtres" method="get">';

  foreach ($sections as $titre => $options) {
    $id = 'section-' . sanitize_title($titre);
    $html .= '<div class="filtre-groupe" style="margin-bottom: 20px;">';
    $html .= '<h4 class="toggle-titre" data-target="' . $id . '">' . esc_html($titre) . ' <span>˅</span></h4>';
    $html .= '<div class="filtre-options" id="' . $id . '" style="display:none;">';

    if ($titre === 'Filtres appliqués') {
      $html .= '<div class="filtres-appliques" id="filtres-appliques" style="margin-bottom: 5px;">';
      if (!empty($filtres_actuels)) {
        foreach ($filtres_actuels as $slug) {
          $html .= '<span style="background:#FF3F22;color:#fff;padding:2px 8px;border-radius:4px;margin-right:4px;">' . esc_html($slug) . '</span>';
        }
      }
      $html .= '</div>';
      $html .= '<span id="reset" style="cursor:pointer; color:#FF3F22;">Tout effacer</span>';
    } else {
      foreach ($options as $opt) {
        if (is_object($opt)) {
          $slug = $opt->slug;
          $label = $opt->name;
        } else {
          $slug = sanitize_title($opt);
          $label = ucfirst($opt);
        }
        $checked = in_array($slug, $filtres_actuels) ? 'checked' : '';
        $html .= '<label style="display:block; margin-bottom: 5px; font-family: DIN Next LT Pro, sans-serif; font-weight: 400; font-size: 14px; color: #000;">';
        $html .= '<input type="checkbox" name="filtre[]" value="' . esc_attr($slug) . '" style="margin-right: 6px;" ' . $checked . '>'; 
        $html .= esc_html($label) . '</label>';
      }
    }

    $html .= '</div><hr class="separator-red"></div>';
  }

  $html .= '<button type="submit" style="background:#FF3F22;color:#fff;padding:6px 16px;border:none;border-radius:6px;">Filtrer</button>';
  $html .= '</form>';

  $html .= "<script>
    document.addEventListener('DOMContentLoaded', function() {
      const resetBtn = document.getElementById('reset');
      if (resetBtn) {
        resetBtn.addEventListener('click', function () {
          document.querySelectorAll('#form-filtres input[type=checkbox]').forEach(cb => cb.checked = false);
          document.getElementById('form-filtres').submit();
        });
      }
    });
  </script>";

  return $html;
}
