 function form_fatty_shortcode() {
  ob_start();
  ?>
 <style>
.form-step {
  display: none;
}
.form-step.active {
  display: block;
}
.form-pagination {
  margin-top: 20px;
  display: flex;
  justify-content: space-between;
  font-family: 'din-next-lt-pro', sans-serif;

}
.radio-group {
  margin-bottom: 18px;
  display: flex;
  gap: 18px;
  flex-wrap: wrap;
}
.progress-bar-container {
  width: 100%;
  background: #fff;
  border-radius: 3px;
  height: 7px;
  margin: 18px 0 24px 0;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.progress-bar {
  height: 100%;
  background: #FF3F22;
  border-radius: 3px;
  transition: width 0.3s;
  width: 0%;
}
.radio-btn {
  display: inline-block;
  border: 2px solid #222;
  border-radius: 10px;
  background: #fff;
  color: #222;
  font-weight: 600;
  font-size: 1rem;
  padding: 12px 24px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s, border 0.2s;
  box-shadow: none;
  outline: none;
  font-family: 'din-next-lt-pro', sans-serif;
}
.radio-btn input[type="radio"], .radio-btn input[type="checkbox"] {
  display: none;
}
.radio-btn.selected {
  background: #222;
  color: #fff;
  border-color: #222;
}
.button-disabled {
  background: #ccc !important;
  color: #888 !important;
  cursor: not-allowed !important;
  pointer-events: none;
}
</style>
<?php if (is_user_logged_in()) : ?>

<form id="multi-step-form">
  <div style="margin-bottom:8px;">
    <span style="font-weight:600;">√âtape <span id="progress-step">1</span>/4</span>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>
  <!-- √âtape 1 -->
  <div class="form-step active" id="step-1">
    <h3>Quel est le mod√®le de votre fourche ?</h3>
    <div class="radio-group">
		<label class="radio-btn"><input type="radio" name="type_fourche" value="Fatty" required> Fatty</label>
	<label class="radio-btn"><input type="radio" name="type_fourche" value="Fatty 50" required> Fatty 50</label>
	<label class="radio-btn"><input type="radio" name="type_fourche" value="Fatty DD 50"> Fatty DD 50</label>
		<label class="radio-btn"><input type="radio" name="type_fourche" value="P-Bone 50/60"> P-Bone 50/60</label>
		<label class="radio-btn"><input type="radio" name="type_fourche" value="Super Fatty"> Super Fatty</label>
		<label class="radio-btn"><input type="radio" name="type_fourche" value="Pepperoni (1√®re et 2√®me g√©n√©ration)"> Pepperoni (1√®re et 2√®me g√©n√©ration)</label>
		<label class="radio-btn"><input type="radio" name="type_fourche" value="Fourches avec jambage aluminium"> Fourches avec jambage aluminium</label>
    </div>
    <div class="form-pagination">
      <span></span>
      <button type="button" id="next-1">Suivant</button>
    </div>
  </div>
  <!-- √âtape 2 -->
  <div class="form-step" id="step-2">
    <h3>Quelles prestations souhaitez-vous ?</h3>
    <div class="radio-group">
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="R√©vision 100 heures" required> R√©vision 100 heures</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="R√©vision 200 heures"> R√©vision 200 heures</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="R√©fection syst√®me Headshok"> R√©fection syst√®me Headshok</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Syst√®me DL50"> Syst√®me DL50</label>
    </div>
    <div class="form-pagination">
      <button type="button" id="prev-2">Pr√©c√©dent</button>
      <button type="button" id="next-2">Suivant</button>
    </div>
  </div>
  <!-- √âtape 3 -->
  <div class="form-step" id="step-3">
    <h3>Souhaitez-vous des options suppl√©mentaires ?</h3>
    <div class="radio-group">
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Tuning hydraulique"> Tuning hydraulique (+59‚Ç¨)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Le tuning hydraulique est une modification des clapets des fourches de v√©lo qui est crucial pour optimiser les performances de la suspension avant, offrant ainsi une meilleure exp√©rience de conduite, une meilleure traction, et un meilleur contr√¥le sur divers terrains. </span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Sans option"> Sans option
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Aucune option suppl√©mentaire s√©lectionn√©e.</span>
        </span>
      </label>
	<div id="prix-total-step3" style="margin:18px 0;font-weight:600;font-size:1.1em;color:#FF3F22;"></div>
    </div>
    <div class="form-pagination">
      <button type="button" id="prev-3">Pr√©c√©dent</button>
      <button type="button" id="next-3">Suivant</button>
    </div>
  </div>
  <!-- √âtape 4 : Inputs -->
  <div class="form-step" id="step-4">
    <h3>Informations compl√©mentaires</h3>
    <div style="margin-bottom:18px;">
      <label for="date-revision" style="font-weight:600;display:block;margin-bottom:6px;">Date de la derni√®re r√©vision</label>
      <input type="date" id="date-revision" name="date_revision" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:320px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="poids-pilote" style="font-weight:600;display:block;margin-bottom:6px;">Poids du pilote (kg)</label>
      <input type="number" id="poids-pilote" name="poids_pilote" min="0" step="1" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:180px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="modele-velo" style="font-weight:600;display:block;margin-bottom:6px;">Mod√®le du v√©lo</label>
      <input type="text" id="modele-velo" name="modele" required style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:250px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="annee-velo" style="font-weight:600;display:block;margin-bottom:6px;">Ann√©e du v√©lo</label>
      <input type="number" id="annee-velo" name="annee" min="1990" max="2030" step="1" required style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:120px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="remarques" style="font-weight:600;display:block;margin-bottom:6px;">Remarques</label>
      <textarea id="remarques" name="remarques" rows="3" style="width:100%;max-width:420px;padding:8px 12px;border-radius:6px;border:1px solid #ccc;"></textarea>
    </div>
    <div style="margin-bottom:18px;">
      <label for="fichier" style="font-weight:600;display:block;margin-bottom:6px;">Joindre un document</label>
      <input type="file" id="fichier" name="fichier" style="padding:8px 0;">
      <input type="hidden" name="url" value="<?php echo home_url( add_query_arg( null, null ) ); ?>">
    </div>
    <div class="form-pagination">
      <button type="button" id="prev-4">Pr√©c√©dent</button>
      <button type="button" id="next-4">Suivant</button>
    </div>
  </div>
  <!-- √âtape 5 : R√©sum√© -->
  <div class="form-step" id="step-5">
    <h3>R√©sum√© de votre demande</h3>
    <div id="resume-content" style="margin-bottom:18px;"></div>
    <div class="form-pagination">
      <button type="button" id="prev-5">Pr√©c√©dent</button>
      <button type="submit">Envoyer</button>
    </div>
  </div>
  <div id="form-result" style="margin-top:20px; color:green;"></div>
</form>
<script>
  // === VARIABLES AJAX PRESTATIONS ===
<?php 
// Utiliser la fonction du functions.php
$ajax_vars = get_ajax_prestations_vars();
?>
window.ajax_object = window.ajax_object || {
    ajax_url: '<?php echo esc_js($ajax_vars['ajax_url']); ?>',
    nonce: '<?php echo esc_js($ajax_vars['nonce']); ?>',
    user_logged_in: <?php echo $ajax_vars['user_logged_in'] ? 'true' : 'false'; ?>
};

// === FONCTION SYNCHRONISATION ===
function synchroniserPrestation(formData, typePrestation) {
    if (!window.ajax_object.user_logged_in) {
        console.log('üë§ Utilisateur non connect√©, synchronisation ignor√©e');
        return Promise.resolve();
    }

    const modele = formData.get('mod√®le') || '';
    const annee = formData.get('ann√©e') || '';
    const prestations = formData.getAll('prestations[]').join(', ');
    
    const prestationData = {
        action: 'sauvegarder_prestation_ajax',
        nonce: window.ajax_object.nonce,
        type_prestation: typePrestation,
        modele_velo: modele,
        annee_velo: annee,
        description: `${typePrestation} - ${prestations} demand√© pour ${modele} (${annee})`,
        statut: 'attente'
    };

    console.log('üîÑ Envoi synchronisation:', prestationData);

    return fetch(window.ajax_object.ajax_url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(prestationData)
    })
    .then(response => {
        console.log('üì° R√©ponse HTTP:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('üìÑ Donn√©es re√ßues:', data);
        if (data.success) {
            console.log('‚úÖ Prestation synchronis√©e:', typePrestation);
        } else {
            console.error('‚ùå Erreur synchronisation:', data);
        }
        return data;
    })
    .catch(error => {
        console.error('‚ùå Erreur r√©seau:', error);
    });
}
// Info dialogue toggle
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.info-toggle').forEach(function(toggle) {
    const dialogue = toggle.querySelector('.info-dialogue');
    toggle.addEventListener('mouseenter', function() {
      dialogue.style.display = 'block';
    });
    toggle.addEventListener('mouseleave', function() {
      dialogue.style.display = 'none';
    });
    toggle.addEventListener('focus', function() {
      dialogue.style.display = 'block';
    });
    toggle.addEventListener('blur', function() {
      dialogue.style.display = 'none';
    });
  });
});
const steps = [
  document.getElementById('step-1'),
  document.getElementById('step-2'),
  document.getElementById('step-3'),
  document.getElementById('step-4'),
  document.getElementById('step-5')
];
let currentStep = 0;
function showStep(index) {
  steps.forEach((step, i) => step.classList.toggle('active', i === index));
  updateProgressBar(index);
  // Focus sur le formulaire pour le centrer √† chaque changement d'√©tape
  const form = document.getElementById('multi-step-form');
  if(form) {
    form.scrollIntoView({behavior: 'smooth', block: 'center'});
  }
}
function updateProgressBar(index) {
  // 4 √©tapes de questions, la 5e est le r√©sum√©
  const totalSteps = 4;
  let stepNum = index + 1;
  if (stepNum > totalSteps) stepNum = totalSteps;
  document.getElementById('progress-step').textContent = stepNum > totalSteps ? totalSteps : stepNum;
  const percent = Math.round((stepNum-1) / totalSteps * 100);
  document.getElementById('progress-bar').style.width = percent + '%';
}
function updateNextButtonState(step, radioName, nextBtnId) {
  const radios = document.getElementsByName(radioName);
  const nextBtn = document.getElementById(nextBtnId);
  function check() {
    let checked = false;
    radios.forEach ? radios.forEach(r => { if(r.checked) checked = true; }) : Array.from(radios).forEach(r => { if(r.checked) checked = true; });
    if (checked) {
      nextBtn.classList.remove('button-disabled');
      nextBtn.disabled = false;
    } else {
      nextBtn.classList.add('button-disabled');
      nextBtn.disabled = true;
    }
  }
  radios.forEach ? radios.forEach(r => r.addEventListener('change', check)) : Array.from(radios).forEach(r => r.addEventListener('change', check));
  check();
}
function updateNext2ButtonState() {
  const dateVal = document.getElementById('date-revision').value;
  const poidsVal = document.getElementById('poids-pilote').value;
  const modeleVal = document.getElementById('modele-velo').value;
  const anneeVal = document.getElementById('annee-velo').value;
  const remarquesVal = document.getElementById('remarques').value;
  const nextBtn = document.getElementById('next-2');
  if(dateVal && poidsVal && modeleVal && anneeVal && remarquesVal) {
    nextBtn.classList.remove('button-disabled');
    nextBtn.disabled = false;
  } else {
    nextBtn.classList.add('button-disabled');
    nextBtn.disabled = true;
  }
}
function updateRadioSelected() {
  document.querySelectorAll('.radio-group').forEach(group => {
    group.querySelectorAll('.radio-btn').forEach(label => {
      const input = label.querySelector('input');
      input.addEventListener('change', function() {
        if(input.type === 'radio') {
          group.querySelectorAll('.radio-btn').forEach(l => l.classList.remove('selected'));
          if(input.checked) label.classList.add('selected');
        } else {
          if(input.checked) label.classList.add('selected');
          else label.classList.remove('selected');
        }
      });
      if(input.checked) label.classList.add('selected');
      else label.classList.remove('selected');
    });
  });
}
	// Prix des prestations et options
const prixPrestations = {
  'R√©vision 100 heures': 79,
  'R√©vision 200 heures': 159,
  'R√©fection syst√®me Headshok':155,
  'Syst√®me DL50': 229
};
const prixOptions = {
  'Tuning hydraulique': 19,
  'Sans option': 0
};

function calculerTotal() {
  const prestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked')).map(cb => cb.value);
  const options = Array.from(document.querySelectorAll('input[name="usage[]"]:checked')).map(cb => cb.value);
  let total = 0;
  prestations.forEach(prestation => {
    if (prixPrestations[prestation]) total += prixPrestations[prestation];
  });
  options.forEach(opt => {
    if (opt === 'Fourreau carbone') {
      // Gratuit si R√©vision 200 heures est s√©lectionn√©e
      total += prestations.includes('R√©vision 200 heures') ? 0 : 399;
    } else if (prixOptions[opt]) {
      total += prixOptions[opt];
    }
  });
  return total;
}

function afficherTotalStep3() {
  const total = calculerTotal();
  document.getElementById('prix-total-step3').textContent = 'Total estim√© : ' + total.toLocaleString('fr-FR', {style:'currency',currency:'EUR'}) + ' TTC';
}

// Mettre √† jour le total √† chaque changement de prestation ou option
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('input[name="prestations[]"]').forEach(function(checkbox) {
    checkbox.addEventListener('change', afficherTotalStep3);
  });
  document.querySelectorAll('input[name="usage[]"]').forEach(function(cb) {
    cb.addEventListener('change', afficherTotalStep3);
  });
  afficherTotalStep3();
});
	// D√©sactivation dynamique des options suppl√©mentaires selon la prestation s√©lectionn√©e
  function updateOptionsState() {
    const prestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked')).map(cb => cb.value);
    const options = [
      'Tuning hydraulique',
      'Sans option'
    ];
    const prestationsSansOptions = [
	'R√©vision 100 heures',
      'R√©fection syst√®me Headshok',
      'Syst√®me DL50'
    ];
    // Si une prestation sans options est s√©lectionn√©e
    const hasNoOptionsPrestation = prestations.some(p => prestationsSansOptions.includes(p));
    if (hasNoOptionsPrestation) {
      options.forEach(opt => {
        const cb = document.querySelector('input[name="usage[]"][value="'+opt+'"]');
        if (cb) {
          cb.disabled = (opt !== 'Sans option');
          cb.parentElement.classList.toggle('button-disabled', opt !== 'Sans option');
        }
      });
      return;
    }
    // R√©activer toutes les options si aucune prestation sans option n'est s√©lectionn√©e
    options.forEach(opt => {
      const cb = document.querySelector('input[name="usage[]"][value="'+opt+'"]');
      if (cb) {
        cb.disabled = false;
        cb.parentElement.classList.remove('button-disabled');
      }
    });
  }

  // √âcouteurs sur prestation
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[name="prestations[]"]').forEach(function(checkbox) {
      checkbox.addEventListener('change', updateOptionsState);
    });
    updateOptionsState();
  });
document.addEventListener('DOMContentLoaded', function() {
  updateNextButtonState('step-1', 'type_fourche', 'next-1');
  // Pour les prestations (checkboxes), on active le bouton suivant si au moins une est coch√©e
  function updateNext2ButtonState() {
    const checkboxes = document.querySelectorAll('input[name="prestations[]"]');
    const nextBtn = document.getElementById('next-2');
    let checked = false;
    checkboxes.forEach(cb => { if(cb.checked) checked = true; });
    if (checked) {
      nextBtn.classList.remove('button-disabled');
      nextBtn.disabled = false;
    } else {
      nextBtn.classList.add('button-disabled');
      nextBtn.disabled = true;
    }
  }
  document.querySelectorAll('input[name="prestations[]"]').forEach(cb => cb.addEventListener('change', updateNext2ButtonState));
  updateNext2ButtonState();
  // Pour les checkboxes, on active le bouton suivant si au moins une est coch√©e
  function updateNext3ButtonState() {
    const checkboxes = document.querySelectorAll('input[name="usage[]"]');
    const nextBtn = document.getElementById('next-3');
    let checked = false;
    checkboxes.forEach(cb => { if(cb.checked) checked = true; });
    if (checked) {
      nextBtn.classList.remove('button-disabled');
      nextBtn.disabled = false;
    } else {
      nextBtn.classList.add('button-disabled');
      nextBtn.disabled = true;
    }
  }
  document.querySelectorAll('input[name="usage[]"]').forEach(cb => cb.addEventListener('change', updateNext3ButtonState));
  updateNext3ButtonState();
  // √âtape 4 : inputs
    function updateNext4ButtonState() {
      const dateVal = document.getElementById('date-revision').value;
      const poidsVal = document.getElementById('poids-pilote').value;
      const modeleVal = document.getElementById('modele-velo').value;
      const anneeVal = document.getElementById('annee-velo').value;
      const nextBtn = document.getElementById('next-4');
      if(dateVal && poidsVal && modeleVal && anneeVal) {
        nextBtn.classList.remove('button-disabled');
        nextBtn.disabled = false;
      } else {
        nextBtn.classList.add('button-disabled');
        nextBtn.disabled = true;
      }
    }
    ['date-revision','poids-pilote','modele-velo','annee-velo'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateNext4ButtonState);
    });
    updateNext4ButtonState();
  updateRadioSelected();
  updateProgressBar(0);
});
document.querySelectorAll('input[type="radio"]').forEach(input => {
  input.addEventListener('change', updateRadioSelected);
});
document.getElementById('next-1').onclick = function() {
  if(document.querySelector('input[name="type_fourche"]:checked')) {
    currentStep = 1; showStep(currentStep);
  }
};
document.getElementById('prev-2').onclick = function() {
  currentStep = 0; showStep(currentStep);
};
document.getElementById('next-2').onclick = function() {
  const checkedPrestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked'));
  if(checkedPrestations.length === 0) {
    checkedPrestations[0]?.focus();
    return;
  }
  currentStep = 2; showStep(currentStep);
};
document.getElementById('prev-3').onclick = function() {
  currentStep = 1;
  showStep(currentStep);
};
document.getElementById('next-3').onclick = function() {
  const checkedUsages = Array.from(document.querySelectorAll('input[name="usage[]"]:checked'));
  if(checkedUsages.length === 0) {
    checkedUsages[0]?.focus();
    return;
  }
  currentStep = 3;
  showStep(currentStep);
};
document.getElementById('prev-4').onclick = function() {
  currentStep = 2; showStep(currentStep);
};
document.getElementById('next-4').onclick = function() {
  // Validation : tous les champs obligatoires sauf remarques
  const dateVal = document.getElementById('date-revision').value;
  const poidsVal = document.getElementById('poids-pilote').value;
  const modeleVal = document.getElementById('modele-velo').value;
  const anneeVal = document.getElementById('annee-velo').value;
  if(!dateVal || !poidsVal || !modeleVal || !anneeVal) {
    if(!dateVal) document.getElementById('date-revision').focus();
    else if(!poidsVal) document.getElementById('poids-pilote').focus();
    else if(!modeleVal) document.getElementById('modele-velo').focus();
    else if(!anneeVal) document.getElementById('annee-velo').focus();
    return;
  }
  // Afficher le r√©sum√©
  const type_fourche = document.querySelector('input[name="type_fourche"]:checked')?.value;
  const prestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked')).map(cb => cb.value).join(', ');
  const usages = Array.from(document.querySelectorAll('input[name="usage[]"]:checked')).map(cb => cb.value).join(', ');
  const date_revision = document.getElementById('date-revision').value;
  const poids_pilote = document.getElementById('poids-pilote').value;
  const modele_velo = document.getElementById('modele-velo').value;
  const annee_velo = document.getElementById('annee-velo').value;
  const modele_annee = `${modele_velo} (${annee_velo})`;
  const remarques = document.getElementById('remarques').value;
  const fichier = document.getElementById('fichier').files[0];
  let fileName = fichier ? fichier.name : 'Aucun';
  const total = calculerTotal();
  document.getElementById('resume-content').innerHTML = `<strong>Type de fourche :</strong> ${type_fourche}<br><strong>Prestations :</strong> ${prestations}<br><strong>Options :</strong> ${usages}<br><strong>Date de la derni√®re r√©vision :</strong> ${date_revision}<br><strong>Poids du pilote :</strong> ${poids_pilote} kg<br><strong>Mod√®le et ann√©e du v√©lo :</strong> ${modele_annee}<br>` + (remarques ? `<strong>Remarques :</strong> ${remarques}<br>` : '') + `<strong>Fichier joint :</strong> ${fileName}<br><span style="color:#FF3F22;font-weight:600;">Total estim√© : ${total.toLocaleString('fr-FR', {style:'currency',currency:'EUR'})} TTC</span>`;
  currentStep = 4; showStep(currentStep);
};
document.getElementById('multi-step-form').onsubmit = function(e) {
  e.preventDefault();
  const type_fourche = document.querySelector('input[name="type_fourche"]:checked')?.value;
  const prestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked')).map(cb => cb.value);
  const usages = Array.from(document.querySelectorAll('input[name="usage[]"]:checked')).map(cb => cb.value);
  const date_revision = document.getElementById('date-revision').value;
  const poids_pilote = document.getElementById('poids-pilote').value;
  const modele_velo = document.getElementById('modele-velo').value;
  const annee_velo = document.getElementById('annee-velo').value;
  const modele_annee = `${modele_velo} (${annee_velo})`;
  const remarques = document.getElementById('remarques').value;
  const fichier = document.getElementById('fichier').files[0];
  const prix_total = calculerTotal();
  var formData = new FormData();
  formData.append('type_fourche', type_fourche);
  prestations.forEach(p => formData.append('prestations[]', p));
  usages.forEach(u => formData.append('usage[]', u));
  formData.append('date_revision', date_revision);
  formData.append('poids_pilote', poids_pilote);
  // Ajouter les champs s√©par√©s pour la synchronisation
  formData.append('mod√®le', modele_velo);
  formData.append('ann√©e', annee_velo);
  // Garder le champ combin√© pour la compatibilit√© email
  formData.append('modele_annee', modele_annee);
  formData.append('remarques', remarques);
  formData.append('prix_total', prix_total);
  if(fichier) formData.append('fichier', fichier);
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/wp-admin/admin-ajax.php?action=envoyer_form_fourche', true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      let response;
      try {
        response = JSON.parse(xhr.responseText);
      } catch (e) {
        response = null;
      }
      let orderNumber = response && response.data && response.data.order_number ? response.data.order_number : null;
      let msg = 'Formulaire envoy√© avec succ√®s !';
      if (typeof synchroniserPrestation !== 'undefined') {
        synchroniserPrestation(formData, 'Fourche Fatty');
      }
      if(orderNumber) {
        msg += `<br><span style="color:#FF3F22;font-weight:600;">Num√©ro de suivi : ${orderNumber}</span>`;
        document.getElementById('resume-content').innerHTML += `<br><strong>Num√©ro de suivi :</strong> <span style='color:#FF3F22;'>${orderNumber}</span>`;
      }
      document.getElementById('form-result').innerHTML = msg;
      document.getElementById('multi-step-form').reset();
      showStep(0);
      updateNextButtonState('step-1', 'type_fourche', 'next-1');
      // R√©initialiser toutes les validations
      document.querySelectorAll('input[name="prestations[]"]').forEach(cb => cb.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="prestations[]"]');
        const nextBtn = document.getElementById('next-2');
        let checked = false;
        checkboxes.forEach(cb => { if(cb.checked) checked = true; });
        if (checked) {
          nextBtn.classList.remove('button-disabled');
          nextBtn.disabled = false;
        } else {
          nextBtn.classList.add('button-disabled');
          nextBtn.disabled = true;
        }
      }));
      document.querySelectorAll('input[name="usage[]"]').forEach(cb => cb.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="usage[]"]');
        const nextBtn = document.getElementById('next-3');
        let checked = false;
        checkboxes.forEach(cb => { if(cb.checked) checked = true; });
        if (checked) {
          nextBtn.classList.remove('button-disabled');
          nextBtn.disabled = false;
        } else {
          nextBtn.classList.add('button-disabled');
          nextBtn.disabled = true;
        }
      }));
      ['date-revision','poids-pilote','modele-velo','annee-velo'].forEach(id => {
        document.getElementById(id).addEventListener('input', function() {
          const dateVal = document.getElementById('date-revision').value;
          const poidsVal = document.getElementById('poids-pilote').value;
          const modeleVal = document.getElementById('modele-velo').value;
          const anneeVal = document.getElementById('annee-velo').value;
          const nextBtn = document.getElementById('next-4');
          if(dateVal && poidsVal && modeleVal && anneeVal) {
            nextBtn.classList.remove('button-disabled');
            nextBtn.disabled = false;
          } else {
            nextBtn.classList.add('button-disabled');
            nextBtn.disabled = true;
          }
        });
      });
      updateRadioSelected();
      updateProgressBar(0);
    } else {
      document.getElementById('form-result').textContent = 'Erreur lors de l‚Äôenvoi.';
    }
  };
  xhr.send(formData);
};
</script>
<?php else : ?>
<div style="text-align:center; margin:40px 0;">
  <p style="font-size:1.2em; font-weight:600;">Vous devez √™tre connect√© pour acc√©der au formulaire.</p>
  <a href="<?php echo wp_login_url(); ?>" class="button" style="background:#FF3F22;color:#fff;padding:12px 32px;border-radius:8px;font-weight:600;text-decoration:none;">Se connecter</a>
</div>
<?php endif; ?>


  <?php
	return ob_get_clean();
}
add_shortcode('form_fatty', 'form_fatty_shortcode');
