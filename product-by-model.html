add_shortcode('produits_par_modele', 'afficher_produits_par_modele');

function afficher_produits_par_modele() {
  ob_start();

  if (!isset($_GET['modele'])) {
    return '<p>Aucun mod√®le s√©lectionn√©.</p>';
  }

  $slug = sanitize_text_field($_GET['modele']);
  $term = get_term_by('slug', $slug, 'product_cat');

  if (!$term) {
    return '<p>Mod√®le introuvable.</p>';
  }

  $modele_slug = sanitize_file_name($slug);
  
  // R√©cup√©ration des champs personnalis√©s de la cat√©gorie
  $chemin_pdf = '';
  $pdf_id = get_term_meta($term->term_id, 'category_pdf', true);
  if ($pdf_id) {
    $chemin_pdf = wp_get_attachment_url($pdf_id);
  }
  
  // R√©cup√©ration de la galerie d'images de la cat√©gorie
  $gallery_ids = get_term_meta($term->term_id, 'category_gallery', true);
  $category_images = [];
  if ($gallery_ids) {
    $gallery_array = explode(',', $gallery_ids);
    foreach ($gallery_array as $image_id) {
      if ($image_id) {
        $image_url = wp_get_attachment_image_url($image_id, 'medium');
        $image_full_url = wp_get_attachment_image_url($image_id, 'full');
        if ($image_url) {
          $category_images[] = [
            'medium' => $image_url,
            'full' => $image_full_url,
            'title' => get_the_title($image_id)
          ];
        }
      }
    }
  }
  
  // R√©cup√©ration du tableau personnalis√© de la cat√©gorie
  $table_data = get_term_meta($term->term_id, 'category_table', true);
  $category_table = null;
  if ($table_data) {
    $category_table = json_decode($table_data, true);
  }

  // üëâ D'abord ex√©cuter la requ√™te pour r√©cup√©rer les produits
	// R√©cup√©ration de tous les produits pour JS (pour bouton voir plus)
	$args_all = [
		'post_type' => 'product',
		'post_status' => 'publish',
		'posts_per_page' => -1,
		'tax_query' => [
			[
				'taxonomy' => 'product_cat',
				'field'    => 'slug',
				'terms'    => $slug,
			],
		],
	];
	$loop_all = new WP_Query($args_all);
	$all_produits = [];
	if ($loop_all->have_posts()) {
		while ($loop_all->have_posts()) {
			$loop_all->the_post();
			global $product;
			$thumbnail = get_the_post_thumbnail($product->get_id(), 'medium');
			if (!$thumbnail) {
				$thumbnail = '<img src="' . wc_placeholder_img_src('medium') . '" alt="Image par d√©faut" />';
			}
			$all_produits[] = [
				'permalink' => get_permalink(),
				'thumbnail' => $thumbnail,
				'title' => get_the_title(),
				'price_html' => $product->get_price_html(),
				'id' => $product->get_id(),
				'sku' => $product->get_sku(),
				'name' => $product->get_name(),
			];
		}
		wp_reset_postdata();
	}

	$limite_affichage = 18;
	$args = [
		'post_type' => 'product',
		'post_status' => 'publish',
		'posts_per_page' => $limite_affichage,
		'tax_query' => [
			[
				'taxonomy' => 'product_cat',
				'field'    => 'slug',
				'terms'    => $slug,
			],
		],
	];

	$loop = new WP_Query($args);
	$produits_total = $loop_all->found_posts;

  // üëâ Ensuite, afficher le HTML
  ?>
  <style>
		#voir-plus {
			display: block;
			margin: 20px auto 0;
			background-color: #000;
			color: #fff;
			padding: 10px 20px;
			font-size: 14px;
			font-family: 'din-next-lt-pro', sans-serif;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}
		#voir-plus:hover {
			background-color: #FF3F22;
			color: #fff;
		}
    .grille-produits-modele {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .produit-modele {
      background-color: #F7F7F7;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      position: relative;
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      min-height: 400px;
      box-sizing: border-box;
    }

    .produit-modele:hover {
      transform: scale(1.03);
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    .produit-modele img {
      max-width: 100%;
      height: auto;
      margin-bottom: 18px;
      border-radius: 6px;
      background: #fff;
      box-shadow: 0 1px 6px rgba(0,0,0,0.07);
      object-fit: contain;
    }

    .info-produit {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: space-between;
      height: 100%;
      flex-grow: 1;
    }

    .texte-produit h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 10px 0;
      color: #000 !important;
      text-align: left;
    }

    .texte-produit p {
      font-size: 14px;
      color: #444;
      margin: 0;
      text-align: left;
    }

    .bouton-ajouter-panier {
      align-self: flex-end;
      background-color: #000000 !important;
      color: #ffffff !important;
      width: 100%;
      border-radius: 6px;
      padding: 10px;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      text-decoration: none;
      margin-top: 5px;
      transition: background-color 0.3s ease;
    }

    .bouton-ajouter-panier:hover {
      background-color: #000000 !important;
      color: #ffffff !important;
    }

	.barre-tri {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 5px;
	}
	#nombre-produits {
	font-family: 'din-next-lt-pro', sans-serif;
	font-weight: 300;
	font-size: 24px;
	color: black;
	margin-right: 2rem;
	}
	.tri-container {
	display: flex;
	align-items: center;
	gap: 10px;
	}
	.tri-container label {
	font-family: 'din-next-lt-pro', sans-serif;
	font-weight: 300;
	font-size: 16px;
	color: #000;
	margin-bottom: 0;
	}
	#tri-sous-categories {
	width: 160px;
	padding: 6px 8px;
	font-family: 'din-next-lt-pro', sans-serif;
	font-size: 14px;
	}
	.separator-red {
	border: none;
	border-top: 2px solid #FF3F22;
	margin: 18px 0;
	}

	.titre-et-manuel {
	  display: flex;
	  justify-content: space-between;
	  align-items: center;
	  flex-wrap: wrap;
	  margin-bottom: 15px;
	  gap: 10px;
	}

	.titre-modele {
	  font-family: Helvetica, sans-serif;
	  font-weight: 700;
	  font-size: 42px;
	  color: #000000;
	  margin: 0;
	}

	.produits-affiches {
	  font-family: 'DIN Next LT Pro', sans-serif;
	  font-weight: 300;
	  font-size: 24px;
	  color: #656565;
	  margin-left: 10px;
	}

	.bouton-manuel {
	  background-color: #151515 !important;
	  color: #F9F9F9 !important;
	  padding: 10px 20px;
	  border-radius: 6px;
	  text-decoration: none;
	  font-weight: 700;
	  font-size: 16px;
	  font-family: 'DIN Next LT Pro', sans-serif;
	  white-space: nowrap;
	  transition: background-color 0.3s ease;
	}

	.bouton-manuel:hover {
	  background-color: #000 !important;
	}

	.images-et-essentiel {
	  display: flex;
	  gap: 30px;
	  flex-wrap: wrap;
	  margin-bottom: 30px;
	  flex-direction: column;
	}

	.images-modele {
	  display: flex;
	  gap: 15px;
	  flex-wrap: wrap;
	  max-width: 70%;
	}

	.modele-image {
	  max-width: 150px;
	  height: auto;
	  border: 1px solid #ccc;
	  border-radius: 6px;
	  cursor: pointer;
	  transition: transform 0.2s ease;
	}

	.modele-image:hover {
	  transform: scale(1.05);
	}

	.boite-essentiel {
	  background-color: #F7F7F7;
	  padding: 20px;
	  border-radius: 8px;
	  flex: 0 0 250px; /* ‚úÖ r√©duit la largeur */
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	  justify-content: flex-start; /* ‚úÖ pour aligner le titre en haut */
	  min-height: 200px;
	}

	.titre-essentiel {
	  font-family: 'DIN Next LT Pro', sans-serif;
	  font-size: 20px;
	  font-weight: 700;
	  margin-bottom: 15px;
	  text-align: center;
	  width: 100%;
	}

	.contenu-essentiel {
	  text-align: left;
	  font-size: 14px;
	  color: #444;
	  width: 100%;
	}

	/* MODAL ZOOM IMAGE */
	#modalZoom {
	  display: none;
	  position: fixed;
	  z-index: 9999;
	  left: 0;
	  top: 0;
	  width: 100%;
	  height: 100%;
	  overflow: auto;
	  background-color: rgba(0,0,0,0.9);
	  padding: 0;
	}

	.modal-content-container {
	  display: flex;
	  justify-content: center;
	  align-items: center;
	  min-height: 100vh;
	  padding: 20px;
	  gap: 30px;
	}

	.main-image-container {
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	}

	#modalZoom img {
	  max-height: 60vh;
	  max-width: 50vw;
	  height: auto;
	  width: auto;
	  cursor: zoom-in;
	  transition: transform 0.3s ease;
	  object-fit: contain;
	  transform-origin: center center;
	}

	#modalZoom .close {
	  position: absolute;
	  top: 20px;
	  right: 35px;
	  color: #fff;
	  font-size: 40px;
	  font-weight: bold;
	  cursor: pointer;
	  transition: 0.3s;
	  z-index: 10001;
	}

	.zoom-instructions {
	  position: absolute;
	  bottom: 20px;
	  left: 50%;
	  transform: translateX(-50%);
	  color: #fff;
	  background: rgba(0, 0, 0, 0.7);
	  padding: 10px 20px;
	  border-radius: 5px;
	  font-family: 'din-next-lt-pro', sans-serif;
	  font-size: 14px;
	  z-index: 10001;
	}

	/* STYLES POUR LE TABLEAU PERSONNALIS√â DE CAT√âGORIE */
	.tableau-category {
	  margin: 30px 0;
	  background-color: #f9f9f9;
	  padding: 20px;
	  border-radius: 8px;
	}

	.titre-tableau {
	  font-family: 'din-next-lt-pro', sans-serif;
	  font-size: 24px;
	  font-weight: 700;
	  margin-bottom: 15px;
	  text-align: center;
	  color: #000;
	}

	.category-table-display {
	  width: 100%;
	  border-collapse: collapse;
	  margin: 20px 0;
	  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
	  background: white;
	}

	.category-table-display td {
	  border: 1px solid #ddd;
	  padding: 12px;
	  background: #f9f9f9;
	  transition: background 0.3s ease;
	  font-family: 'din-next-lt-pro', sans-serif;
	  font-size: 14px;
	}

	.category-table-display tr:nth-child(even) td {
	  background: #f1f1f1;
	}

	.category-table-display tr:hover td {
	  background: #e8f4f8;
	}

	.category-table-display tr:first-child td {
	  font-weight: 600;
	  background: #e0e0e0 !important;
	  color: #000;
	}

	  /* Responsive Design */
      @media screen and (max-width: 1129px) {
        .grille-produits-modele {
          grid-template-columns: repeat(2, 1fr);
        }
        .barre-tri {
          flex-direction: column;
          align-items: stretch;
          gap: 15px;
        }
        .tri-container {
          justify-content: center;
          flex-wrap: wrap;
        }
      }
	  @media (max-width: 1024px) {
		.modal-content-container {
			flex-direction: column;
			gap: 20px;
		}
		
		#modalZoom img {
			max-width: 90vw;
			max-height: 70vh;
		}
	}
      
      @media screen and (max-width: 768px) {
        .grille-produits-modele {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
        }
        .produit-modele {
          min-height: 0px;
        }
        .texte-produit h3 {
          font-size: 14px;
        }
        .bouton-ajouter-panier {
          padding: 8px 12px;
          font-size: 14px;
        }
        .barre-tri {
          flex-direction: column;
          gap: 10px;
        }
        #tri-sous-categories {
          width: 100px;
        }
      }
  </style>
	<div class="titre-et-manuel">
	  <h1 class="titre-modele">
		<?php echo esc_html($term->name); ?>
	  </h1>

	  <?php if ($chemin_pdf): ?>
		<a href="<?php echo esc_url($chemin_pdf); ?>" download class="bouton-manuel">T√âL√âCHARGER LE MANUEL</a>
	  <?php else: ?>
		<p style="color: #777; font-size: 14px;">Aucun manuel PDF disponible.</p>
	  <?php endif; ?>
	</div>

	<div class="images-et-essentiel">
	  <div class="images-modele">
		<?php
		  // Afficher d'abord les images de la galerie de cat√©gorie
		  if (!empty($category_images)) {
		    foreach ($category_images as $img) {
		      echo '<img src="' . esc_url($img['medium']) . '" alt="' . esc_attr($img['title']) . '" class="modele-image" onclick="ouvrirImageZoom(&quot;' . esc_url($img['full']) . '&quot;)">';
		    }
		  } else {
		    // Si pas d'images dans la galerie de cat√©gorie, utiliser l'ancienne m√©thode
		    $images_args = [
		      'post_type'      => 'attachment',
		      'post_mime_type' => 'image',
		      'posts_per_page' => -1,
		      'post_status'    => 'inherit',
		      's'              => $modele_slug
		    ];

		    $images_query = new WP_Query($images_args);

		    if ($images_query->have_posts()) {
		      while ($images_query->have_posts()) {
		        $images_query->the_post();
		        $image_url = wp_get_attachment_image_src(get_the_ID(), 'medium')[0];
		        $image_full_url = wp_get_attachment_image_src(get_the_ID(), 'full')[0];
		        echo '<img src="' . esc_url($image_url) . '" alt="' . esc_attr(get_the_title()) . '" class="modele-image" onclick="ouvrirImageZoom(&quot;' . esc_url($image_full_url) . '&quot;)">';
		      }
		      wp_reset_postdata();
		    } else {
		      echo '<p style="font-size: 14px; color: #777;">Aucune image disponible pour ce mod√®le.</p>';
		    }
		  }
		?>
	  </div>

	  <?php
	  // Affichage du tableau personnalis√© de la cat√©gorie (si disponible)
	  if ($category_table && isset($category_table['rows']) && isset($category_table['cols']) && isset($category_table['data'])) {
	    echo '<div class="tableau-category">';
	    echo '<h3 class="titre-tableau">Informations techniques</h3>';
	    echo '<table class="category-table-display">';
	    for ($i = 0; $i < $category_table['rows']; $i++) {
	      echo '<tr>';
	      for ($j = 0; $j < $category_table['cols']; $j++) {
	        $cell_content = isset($category_table['data'][$i][$j]) ? $category_table['data'][$i][$j] : '';
	        echo '<td>' . esc_html($cell_content) . '</td>';
	      }
	      echo '</tr>';
	    }
	    echo '</table>';
	    echo '</div>';
	  }
	  ?>
	</div>

  <div id="produits-filtrables-container" style="display:flex; flex-direction: column; gap:20px; margin-bottom: 2%;">
    <div class="barre-tri">
      <div style="display: flex; align-items: center;">
        <div id="nombre-produits">
          <span class="produits-affiches"><?php echo $produits_total; ?> r√©sultats</span>
        </div>
      </div>
      <div class="tri-container">
        <label for="tri-sous-categories">Trier par :</label>
        <select id="tri-sous-categories">
          <option value="default">Tri par d√©faut</option>
          <option value="alpha">Ordre alphab√©tique A-Z</option>
          <option value="alpha-desc">Ordre alphab√©tique Z-A</option>
        </select>
      </div>
    </div>
    <hr class="separator-red">
  </div>
  <?php

  // üëâ Puis afficher les produits
	if ($loop->have_posts()) {
		echo '<div class="grille-produits-modele" id="grille-produits-modele">';
		$i = 0;
		while ($loop->have_posts() && $i < $limite_affichage) {
			$loop->the_post();
			global $product;
			$thumbnail = get_the_post_thumbnail($product->get_id(), 'medium');
			if (!$thumbnail) {
				$thumbnail = '<img src="' . wc_placeholder_img_src('medium') . '" alt="Image par d√©faut" />';
			}
			echo '<div class="produit-modele">';
			echo '<a href="' . get_permalink() . '">' . $thumbnail . '</a>';
			echo '<div class="info-produit">';
			echo '<div class="texte-produit">';
			echo '<h3>' . get_the_title() . '</h3>';
			echo '<p>' . $product->get_price_html() . '</p>';
			echo '</div>';
			echo '<a href="' . esc_url('?add-to-cart=' . $product->get_id()) . '" 
								data-quantity="1" 
								class="bouton-ajouter-panier add_to_cart_button ajax_add_to_cart" 
								data-product_id="' . esc_attr($product->get_id()) . '" 
								data-product_sku="' . esc_attr($product->get_sku()) . '" 
								aria-label="Ajouter ‚Äú' . esc_attr($product->get_name()) . '‚Äù au panier" 
								rel="nofollow">Ajouter au panier</a>';
			echo '</div>';
			echo '</div>';
			$i++;
		}
		echo '</div>';
			if ($produits_total > $limite_affichage) {
				echo '<button id="voir-plus">Voir plus</button>';
			}
		wp_reset_postdata();
	} else {
		echo '<p>Aucun produit trouv√© pour ce mod√®le.</p>';
	}
	if ($produits_total > $limite_affichage) : ?>
		<script>
			window.allProduitsByModel = <?php echo json_encode($all_produits); ?>;
		</script>
	<?php endif; ?>
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const triSelect = document.getElementById('tri-sous-categories');
			const grille = document.getElementById('grille-produits-modele');
			const voirPlusBtn = document.getElementById('voir-plus');
			if (triSelect && grille) {
				triSelect.addEventListener('change', function () {
					const items = Array.from(grille.querySelectorAll('.produit-modele'));
					if (this.value === 'alpha') {
						items.sort((a, b) => a.querySelector('h3').textContent.localeCompare(b.querySelector('h3').textContent));
					} else if (this.value === 'alpha-desc') {
						items.sort((a, b) => b.querySelector('h3').textContent.localeCompare(a.querySelector('h3').textContent));
					} else {
						return;
					}
					items.forEach(item => grille.appendChild(item));
				});
			}
			if (voirPlusBtn && window.allProduitsByModel) {
				voirPlusBtn.addEventListener('click', function (e) {
					e.preventDefault();
					grille.innerHTML = '';
					window.allProduitsByModel.forEach(function(p) {
						const div = document.createElement('div');
						div.className = 'produit-modele';
						div.innerHTML = `
							<a href="${p.permalink}">${p.thumbnail}</a>
							<div class=\"info-produit\">
								<div class=\"texte-produit\">
									<h3>${p.title}</h3>
									<p>${p.price_html}</p>
								</div>
								<a href="?add-to-cart=${p.id}" data-quantity="1" class="bouton-ajouter-panier add_to_cart_button ajax_add_to_cart" data-product_id="${p.id}" data-product_sku="${p.sku}" aria-label="Ajouter ‚Äú${p.name}‚Äù au panier" rel="nofollow">Ajouter au panier</a>
							</div>
						`;
						grille.appendChild(div);
					});
					voirPlusBtn.style.display = 'none';
				});
			}
		});
	</script>

  ?>

	

	<div id="modalZoom" onclick="fermerImageZoom()">
	  <span class="close">&times;</span>
	  <div class="modal-content-container">
	    <div class="main-image-container">
	      <img id="imageZoomee" src="" onclick="event.stopPropagation();">
	    </div>
	  </div>
	  <div class="zoom-instructions">
	    Cliquez sur l'image pour zoomer (Niveau 1/3)
	  </div>
	</div>

	<script>
	// Encapsuler tout le code de zoom dans DOMContentLoaded
	document.addEventListener('DOMContentLoaded', function() {
		let zoomLevel = 0; // Niveau de zoom actuel (0, 1, 2, 3)
		const maxZoomLevels = 3; // Maximum 3 niveaux de zoom
		const zoomScales = [1, 1.5, 2.5, 4]; // Facteurs d'agrandissement pour chaque niveau

		// V√©rifier si on est sur un √©cran d'ordinateur (largeur > 1024px)
		function isDesktop() {
		  return window.innerWidth > 1024;
		}

		// Fonction globale pour ouvrir le zoom
		window.ouvrirImageZoom = function(src) {
		  console.log('Fonction ouvrirImageZoom appel√©e avec:', src);
		  
		  const modal = document.getElementById("modalZoom");
		  const img = document.getElementById("imageZoomee");
		  
		  console.log('√âl√©ments trouv√©s:', { modal, img }); // Debug
		  
		  // V√©rifier que les √©l√©ments existent
		  if (!modal) {
		    console.error('Modal non trouv√©:', modal);
		    return;
		  }
		  
		  if (!img) {
		    console.error('Image non trouv√©e:', img);
		    return;
		  }
		  
		  try {
		    modal.style.display = "block";
		    img.src = src;
		    
		    // R√©initialiser le zoom
		    zoomLevel = 0;
		    img.style.transform = 'scale(1)';
		    img.style.cursor = 'zoom-in';
		    
		    // Mettre √† jour les instructions initiales
		    updateZoomInstructions();
		    
		    // Configurer le zoom par clic
		    setupClickZoom();
		    
		    console.log('Modal ouvert avec succ√®s'); // Debug
		  } catch (error) {
		    console.error('Erreur lors de l\'ouverture du modal:', error);
		  }
		}

		// Fonction globale pour fermer le zoom
		window.fermerImageZoom = function() {
		  const modal = document.getElementById("modalZoom");
		  if (modal) {
		    modal.style.display = "none";
		    zoomLevel = 0;
		  }
		}

		// Fonction globale pour g√©rer le clic sur l'image
		function handleImageClick(e) {
		  e.stopPropagation();
		  
		  const img = document.getElementById("imageZoomee");
		  
		  // V√©rifier que l'image existe
		  if (!img) {
		    console.error('Image non trouv√©e dans handleImageClick');
		    return;
		  }
		  
		  // Passer au niveau de zoom suivant
		  zoomLevel++;
		  
		  // Si on d√©passe le maximum, revenir au niveau 0
		  if (zoomLevel > maxZoomLevels) {
		    zoomLevel = 0;
		  }
		  
		  // Appliquer le nouveau niveau de zoom
		  const scale = zoomScales[zoomLevel];
		  img.style.transform = `scale(${scale})`;
		  img.style.transformOrigin = 'center center';
		  img.style.transition = 'transform 0.3s ease';
		  
		  // Mettre √† jour le curseur selon le niveau de zoom
		  if (zoomLevel === 0) {
		    img.style.cursor = 'zoom-in';
		  } else if (zoomLevel === maxZoomLevels) {
		    img.style.cursor = 'zoom-out';
		  } else {
		    img.style.cursor = 'zoom-in';
		  }
		  
		  // Mettre √† jour les instructions
		  updateZoomInstructions();
		  
		  console.log('Zoom level:', zoomLevel, 'Scale:', scale); // Debug
		}

		function setupClickZoom() {
		  const img = document.getElementById("imageZoomee");
		  
		  // V√©rifier que l'image existe
		  if (!img) {
		    console.error('Image non trouv√©e pour setupClickZoom');
		    return;
		  }
		  
		  // Nettoyer les anciens event listeners
		  img.removeEventListener('click', handleImageClick);
		  
		  // Ajouter le nouvel event listener pour le clic
		  img.addEventListener('click', handleImageClick);
		  
		  console.log('Event listener ajout√© pour le zoom'); // Debug
		}

		function updateZoomInstructions() {
		  const instructions = document.querySelector('.zoom-instructions');
		  
		  // V√©rifier que l'√©l√©ment existe
		  if (!instructions) {
		    console.error('Instructions non trouv√©es');
		    return;
		  }
		  
		  if (zoomLevel === 0) {
		    instructions.textContent = 'Cliquez sur l\'image pour zoomer (Niveau 1/3)';
		  } else if (zoomLevel === maxZoomLevels) {
		    instructions.textContent = 'Cliquez pour revenir √† la taille normale';
		  } else {
		    instructions.textContent = `Zoom niveau ${zoomLevel}/3 ‚Ä¢ Cliquez pour zoomer davantage`;
		  }
		}

		// Gestion responsive
		window.addEventListener('resize', function() {
		  if (!isDesktop()) {
		    // Sur mobile/tablette, r√©initialiser le zoom
		    const img = document.getElementById("imageZoomee");
		    if (img) {
		      zoomLevel = 0;
		      img.style.transform = 'scale(1)';
		      img.style.cursor = 'default';
		    }
		  }
		});
		
		console.log('Script de zoom initialis√© avec succ√®s');
	});
	</script>

  <?php

	if (current_user_can('administrator') && isset($_POST['sauver_contenu_essentiel'])) {
	  $contenu_sauvegarde = wp_kses_post($_POST['contenu_essentiel']);
	  update_option('contenu_essentiel_' . $modele_slug, $contenu_sauvegarde);

	  // Redirection propre vers la m√™me URL en GET (PRG pattern)
	  $url_actuelle = esc_url_raw(add_query_arg(null, null));
	  wp_redirect($url_actuelle);
	  exit;
	}

  return ob_get_clean();
}
