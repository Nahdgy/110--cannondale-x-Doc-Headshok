add_shortcode('produits_par_modele', 'afficher_produits_par_modele');

function afficher_produits_par_modele() {
  ob_start();

  if (!isset($_GET['modele'])) {
    return '<p>Aucun mod√®le s√©lectionn√©.</p>';
  }

  $slug = sanitize_text_field($_GET['modele']);
  $term = get_term_by('slug', $slug, 'product_cat');

  if (!$term) {
    return '<p>Mod√®le introuvable.</p>';
  }

  $modele_slug = sanitize_file_name($slug);
  $chemin_pdf = '';
	$pdf_query = new WP_Query([
	  'post_type' => 'attachment',
	  'post_status' => 'inherit',
	  'post_mime_type' => 'application/pdf',
	  'posts_per_page' => 1,
	  's' => $modele_slug
	]);

	if ($pdf_query->have_posts()) {
	  $pdf_query->the_post();
	  $chemin_pdf = wp_get_attachment_url(get_the_ID());
	  wp_reset_postdata();
	}

  // üëâ D'abord ex√©cuter la requ√™te pour r√©cup√©rer les produits
	// R√©cup√©ration de tous les produits pour JS (pour bouton voir plus)
	$args_all = [
		'post_type' => 'product',
		'post_status' => 'publish',
		'posts_per_page' => -1,
		'tax_query' => [
			[
				'taxonomy' => 'product_cat',
				'field'    => 'slug',
				'terms'    => $slug,
			],
		],
	];
	$loop_all = new WP_Query($args_all);
	$all_produits = [];
	if ($loop_all->have_posts()) {
		while ($loop_all->have_posts()) {
			$loop_all->the_post();
			global $product;
			$thumbnail = get_the_post_thumbnail($product->get_id(), 'medium');
			if (!$thumbnail) {
				$thumbnail = '<img src="' . wc_placeholder_img_src('medium') . '" alt="Image par d√©faut" />';
			}
			$all_produits[] = [
				'permalink' => get_permalink(),
				'thumbnail' => $thumbnail,
				'title' => get_the_title(),
				'price_html' => $product->get_price_html(),
				'id' => $product->get_id(),
				'sku' => $product->get_sku(),
				'name' => $product->get_name(),
			];
		}
		wp_reset_postdata();
	}

	$limite_affichage = 18;
	$args = [
		'post_type' => 'product',
		'post_status' => 'publish',
		'posts_per_page' => $limite_affichage,
		'tax_query' => [
			[
				'taxonomy' => 'product_cat',
				'field'    => 'slug',
				'terms'    => $slug,
			],
		],
	];

	$loop = new WP_Query($args);
	$produits_total = $loop_all->found_posts;

  // üëâ Ensuite, afficher le HTML
  ?>
	<div class="titre-et-manuel">
	  <h1 class="titre-modele">
		<?php echo esc_html($term->name); ?>
	  </h1>

	  <?php if ($chemin_pdf): ?>
		<a href="<?php echo esc_url($chemin_pdf); ?>" download class="bouton-manuel">T√âL√âCHARGER LE MANUEL</a>
	  <?php else: ?>
		<p style="color: #777; font-size: 14px;">Aucun manuel PDF disponible.</p>
	  <?php endif; ?>
	</div>

	<div class="images-et-essentiel">
	  <div class="images-modele">
		<?php
		  $images_args = [
			'post_type'      => 'attachment',
			'post_mime_type' => 'image',
			'posts_per_page' => -1,
			'post_status'    => 'inherit',
			's'              => $modele_slug
		  ];

		  $images_query = new WP_Query($images_args);

		  if ($images_query->have_posts()) {
			while ($images_query->have_posts()) {
			  $images_query->the_post();
			  $image_url = wp_get_attachment_image_src(get_the_ID(), 'medium')[0];
			  echo '<img src="' . esc_url($image_url) . '" alt="' . esc_attr(get_the_title()) . '" class="modele-image" onclick="ouvrirImageZoom(this.src)">';
			}
			wp_reset_postdata();
		  } else {
			echo '<p style="font-size: 14px; color: #777;">Aucune image disponible pour ce mod√®le.</p>';
		  }
		?>
	  </div>

		<?php
		  $contenu_essentiel = get_option('contenu_essentiel_' . $modele_slug);
		  if (current_user_can('administrator')) {
			// formulaire pour l‚Äôadmin
			echo '<div class="boite-essentiel">';
			echo '<p class="titre-essentiel">Les pi√®ces essentielles</p>';
			echo '<form method="post">';
			wp_editor($contenu_essentiel, 'contenu_essentiel', [
			  'textarea_name' => 'contenu_essentiel',
			  'textarea_rows' => 5,
			  'media_buttons' => false,
			]);
			echo '<input type="submit" name="sauver_contenu_essentiel" value="Sauvegarder" class="button button-primary" style="margin-top: 10px;" />';
			echo '</form>';
			echo '</div>';
		  } elseif (!empty($contenu_essentiel)) {
			// affichage lecture seule
			echo '<div class="boite-essentiel">';
			echo '<p class="titre-essentiel">Les pi√®ces essentielles</p>';
			echo '<div class="contenu-essentiel">' . wp_kses_post(wpautop($contenu_essentiel)) . '</div>';
			echo '</div>';
		  }
		?>
	</div>

  <div id="produits-filtrables-container" style="display:flex; flex-direction: column; gap:20px; margin-bottom: 2%;">
    <div class="barre-tri">
      <div style="display: flex; align-items: center;">
        <div id="nombre-produits">
          <span class="produits-affiches"><?php echo $produits_total; ?> r√©sultats</span>
        </div>
      </div>
      <div class="tri-container">
        <label for="tri-sous-categories">Trier par :</label>
        <select id="tri-sous-categories">
          <option value="default">Tri par d√©faut</option>
          <option value="alpha">Ordre alphab√©tique A-Z</option>
          <option value="alpha-desc">Ordre alphab√©tique Z-A</option>
        </select>
      </div>
    </div>
    <hr class="separator-red">
  </div>
  <?php

  // üëâ Puis afficher les produits
	if ($loop->have_posts()) {
		echo '<div class="grille-produits-modele" id="grille-produits-modele">';
		$i = 0;
		while ($loop->have_posts() && $i < $limite_affichage) {
			$loop->the_post();
			global $product;
			$thumbnail = get_the_post_thumbnail($product->get_id(), 'medium');
			if (!$thumbnail) {
				$thumbnail = '<img src="' . wc_placeholder_img_src('medium') . '" alt="Image par d√©faut" />';
			}
			echo '<div class="produit-modele">';
			echo '<a href="' . get_permalink() . '">' . $thumbnail . '</a>';
			echo '<div class="info-produit">';
			echo '<div class="texte-produit">';
			echo '<h3>' . get_the_title() . '</h3>';
			echo '<p>' . $product->get_price_html() . '</p>';
			echo '</div>';
			echo '<a href="' . esc_url('?add-to-cart=' . $product->get_id()) . '" 
								data-quantity="1" 
								class="bouton-ajouter-panier add_to_cart_button ajax_add_to_cart" 
								data-product_id="' . esc_attr($product->get_id()) . '" 
								data-product_sku="' . esc_attr($product->get_sku()) . '" 
								aria-label="Ajouter ‚Äú' . esc_attr($product->get_name()) . '‚Äù au panier" 
								rel="nofollow">Ajouter au panier</a>';
			echo '</div>';
			echo '</div>';
			$i++;
		}
		echo '</div>';
			if ($produits_total > $limite_affichage) {
				echo '<div style="display: flex; justify-content: center; width: 100%;"><button class="btn-voir-plus" id="voir-plus">Voir plus</button></div>';
			}
		wp_reset_postdata();
	} else {
		echo '<p>Aucun produit trouv√© pour ce mod√®le.</p>';
	}
	if ($produits_total > $limite_affichage) : ?>
		<script>
			window.allProduitsByModel = <?php echo json_encode($all_produits); ?>;
		</script>
	<?php endif; ?>
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const triSelect = document.getElementById('tri-sous-categories');
			const grille = document.getElementById('grille-produits-modele');
			const voirPlusBtn = document.getElementById('voir-plus');
			if (triSelect && grille) {
				triSelect.addEventListener('change', function () {
					const items = Array.from(grille.querySelectorAll('.produit-modele'));
					if (this.value === 'alpha') {
						items.sort((a, b) => a.querySelector('h3').textContent.localeCompare(b.querySelector('h3').textContent));
					} else if (this.value === 'alpha-desc') {
						items.sort((a, b) => b.querySelector('h3').textContent.localeCompare(a.querySelector('h3').textContent));
					} else {
						return;
					}
					items.forEach(item => grille.appendChild(item));
				});
			}
			if (voirPlusBtn && window.allProduitsByModel) {
				voirPlusBtn.addEventListener('click', function (e) {
					e.preventDefault();
					grille.innerHTML = '';
					window.allProduitsByModel.forEach(function(p) {
						const div = document.createElement('div');
						div.className = 'produit-modele';
						div.innerHTML = `
							<a href="${p.permalink}">${p.thumbnail}</a>
							<div class=\"info-produit\">
								<div class=\"texte-produit\">
									<h3>${p.title}</h3>
									<p>${p.price_html}</p>
								</div>
								<a href="?add-to-cart=${p.id}" data-quantity="1" class="bouton-ajouter-panier add_to_cart_button ajax_add_to_cart" data-product_id="${p.id}" data-product_sku="${p.sku}" aria-label="Ajouter ‚Äú${p.name}‚Äù au panier" rel="nofollow">Ajouter au panier</a>
							</div>
						`;
						grille.appendChild(div);
					});
					voirPlusBtn.style.display = 'none';
				});
			}
		});
	</script>

  ?>

	<style>
		.btn-voir-plus {
			display: block;
			margin: 30px auto 0 auto;
			background-color: black;
			color: white;
			padding: 10px 20px;
			font-size: 16px;
			font-family: 'DIN Next LT Pro', sans-serif;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			transition: background 0.2s, color 0.2s;
		}
		.btn-voir-plus:hover {
			background-color: #FF3F22;
			color: #fff;
		}
    .grille-produits-modele {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 30px;
    }

    @media (max-width: 768px) {
      .grille-produits-modele {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .grille-produits-modele {
        grid-template-columns: 1fr;
      }
    }

    .produit-modele {
      background-color: #F7F7F7;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      position: relative;
      transition: transform 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .produit-modele:hover {
      transform: translateY(-5px);
    }

    .produit-modele img {
      max-width: 100%;
      height: auto;
      margin-bottom: 10px;
      object-fit: contain;
    }

    .info-produit {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: space-between;
      height: 100%;
      flex-grow: 1;
    }

    .texte-produit h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 5px;
      color: #000;
      text-align: left;
    }

    .texte-produit p {
      font-size: 14px;
      color: #444;
      margin: 0;
      text-align: left;
    }

    .bouton-ajouter-panier {
      align-self: flex-end;
      background-color: #000000 !important;
      color: #ffffff !important;
      width: 100%;
      border-radius: 10px;
		padding: 2px;
      text-align: center;
      line-height: 30px;
      font-size: 20px;
      font-weight: bold;
      text-decoration: none;
      margin-top: 5px;
    }

    .bouton-ajouter-panier:hover {
      background-color: #000000 !important;
      color: #ffffff !important;
    }

      .barre-tri {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }
      #nombre-produits {
        font-family: 'DIN Next LT Pro', sans-serif;
        font-weight: 300;
        font-size: 24px;
        color: #656565;
      }
      .tri-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .tri-container label {
        font-family: 'DIN Next LT Pro', sans-serif;
        font-weight: 300;
        font-size: 16px;
        color: #000;
        margin-bottom: 0;
      }
      #tri-sous-categories {
        width: 160px;
        padding: 6px 8px;
        font-family: 'DIN Next LT Pro', sans-serif;
        font-size: 14px;
      }
      .separator-red {
        border: none;
        border-bottom: 2px solid #FF3F22;
        margin: 0 0 20px 0;
        width: 100%;
      }

	.titre-et-manuel {
	  display: flex;
	  justify-content: space-between;
	  align-items: center;
	  flex-wrap: wrap;
	  margin-bottom: 15px;
	  gap: 10px;
	}

	.titre-modele {
	  font-family: Helvetica, sans-serif;
	  font-weight: 700;
	  font-size: 42px;
	  color: #000000;
	  margin: 0;
	}

	.produits-affiches {
	  font-family: 'DIN Next LT Pro', sans-serif;
	  font-weight: 300;
	  font-size: 24px;
	  color: #656565;
	  margin-left: 10px;
	}

	.bouton-manuel {
	  background-color: #151515 !important;
	  color: #F9F9F9 !important;
	  padding: 10px 20px;
	  border-radius: 6px;
	  text-decoration: none;
	  font-weight: 700;
	  font-size: 16px;
	  font-family: 'DIN Next LT Pro', sans-serif;
	  white-space: nowrap;
	  transition: background-color 0.3s ease;
	}

	.bouton-manuel:hover {
	  background-color: #000 !important;
	}

	.images-et-essentiel {
	  display: flex;
	  gap: 30px;
	  flex-wrap: wrap;
	  margin-bottom: 30px;
	}

	.images-modele {
	  display: flex;
	  gap: 15px;
	  flex-wrap: wrap;
	  max-width: 70%;
	}

	.modele-image {
	  max-width: 150px;
	  height: auto;
	  border: 1px solid #ccc;
	  border-radius: 6px;
	  cursor: pointer;
	  transition: transform 0.2s ease;
	}

	.modele-image:hover {
	  transform: scale(1.05);
	}

	.boite-essentiel {
	  background-color: #F7F7F7;
	  padding: 20px;
	  border-radius: 8px;
	  flex: 0 0 250px; /* ‚úÖ r√©duit la largeur */
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	  justify-content: flex-start; /* ‚úÖ pour aligner le titre en haut */
	  min-height: 200px;
	}

	.titre-essentiel {
	  font-family: 'DIN Next LT Pro', sans-serif;
	  font-size: 20px;
	  font-weight: 700;
	  margin-bottom: 15px;
	  text-align: center;
	  width: 100%;
	}

	.contenu-essentiel {
	  text-align: left;
	  font-size: 14px;
	  color: #444;
	  width: 100%;
	}

	/* MODAL ZOOM IMAGE */
	#modalZoom {
	  display: none;
	  position: fixed;
	  z-index: 9999;
	  padding-top: 60px;
	  left: 0;
	  top: 0;
	  width: 100%;
	  height: 100%;
	  overflow: auto;
	  background-color: rgba(0,0,0,0.9);
	}

	#modalZoom img {
	  margin: auto;
	  display: block;
	  height: 40rem;
	}

	#modalZoom .close {
	  position: absolute;
	  top: 20px;
	  right: 35px;
	  color: #fff;
	  font-size: 40px;
	  font-weight: bold;
	  cursor: pointer;
	  transition: 0.3s;
	}
  </style>

	<div id="modalZoom" onclick="fermerImageZoom()">
	  <span class="close">&times;</span>
	  <img id="imageZoomee" src="">
	</div>

	<script>
	function ouvrirImageZoom(src) {
	  document.getElementById("modalZoom").style.display = "block";
	  document.getElementById("imageZoomee").src = src;
	}
	function fermerImageZoom() {
	  document.getElementById("modalZoom").style.display = "none";
	}
	</script>

  <?php

	if (current_user_can('administrator') && isset($_POST['sauver_contenu_essentiel'])) {
	  $contenu_sauvegarde = wp_kses_post($_POST['contenu_essentiel']);
	  update_option('contenu_essentiel_' . $modele_slug, $contenu_sauvegarde);

	  // Redirection propre vers la m√™me URL en GET (PRG pattern)
	  $url_actuelle = esc_url_raw(add_query_arg(null, null));
	  wp_redirect($url_actuelle);
	  exit;
	}

  return ob_get_clean();
}
