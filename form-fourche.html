<style>
.form-step {
  display: none;
}
.form-step.active {
  display: block;
}
.form-pagination {
  margin-top: 20px;
  display: flex;
  justify-content: space-between;
}
.radio-group {
  margin-bottom: 18px;
  display: flex;
  gap: 18px;
  flex-wrap: wrap;
}
.progress-bar-container {
  width: 100%;
  background: #fff;
  border-radius: 3px;
  height: 7px;
  margin: 18px 0 24px 0;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.progress-bar {
  height: 100%;
  background: #FF3F22;
  border-radius: 3px;
  transition: width 0.3s;
  width: 0%;
}
.radio-btn {
  display: inline-block;
  border: 2px solid #222;
  border-radius: 10px;
  background: #fff;
  color: #222;
  font-weight: 600;
  font-size: 1rem;
  padding: 12px 24px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s, border 0.2s;
  box-shadow: none;
  outline: none;
}
.radio-btn input[type="radio"], .radio-btn input[type="checkbox"] {
  display: none;
}
.radio-btn.selected {
  background: #222;
  color: #fff;
  border-color: #222;
}
.button-disabled {
  background: #ccc !important;
  color: #888 !important;
  cursor: not-allowed !important;
  pointer-events: none;
}
</style>
<?php if (is_user_logged_in()) : ?>

<form id="multi-step-form">
  <div style="margin-bottom:8px;">
    <span style="font-weight:600;">Étape <span id="progress-step">1</span>/4</span>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>
  <!-- Étape 1 -->
  <div class="form-step active" id="step-1">
    <h3>Quel est le modèle de votre fourche ?</h3>
    <div class="radio-group">
      <label class="radio-btn"><input type="radio" name="type_fourche" value="Lefty Ocho 27,5 100mm" required> Lefty Ocho 27,5 100mm</label>
      <label class="radio-btn"><input type="radio" name="type_fourche" value="Lefty Ocho 29 100mm"> Lefty Ocho 29 100mm</label>
      <label class="radio-btn"><input type="radio" name="type_fourche" value="Lefty Ocho 29 110mm"> Lefty Ocho 29 110mm</label>
      <label class="radio-btn"><input type="radio" name="type_fourche" value="Lefty Ocho 29 120mm"> Lefty Ocho 29 120mm</label>
      <label class="radio-btn"><input type="radio" name="type_fourche" value="Lefty Oliver"> Lefty Oliver</label>
    </div>
    <div class="form-pagination">
      <span></span>
      <button type="button" id="next-1">Suivant</button>
    </div>
  </div>
  <!-- Étape 2 -->
  <div class="form-step" id="step-2">
    <h3>Quelles prestations souhaitez-vous ?</h3>
    <div class="radio-group">
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Révision 100 heures" required> Révision 100 heures</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Révision 200 heures"> Révision 200 heures</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Révision Full Package"> Révision Full Package</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Optimisation système Headshok"> Optimisation système Headshok</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Réfection système Headshok"> Réfection système Headshok</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Garantie Cannondale"> Garantie Cannondale</label>
      <label class="radio-btn"><input type="checkbox" name="prestations[]" value="Remplacement filet rapporté (hélicoil)"> Remplacement filet rapporté (hélicoil)</label>
    </div>
    <div class="form-pagination">
      <button type="button" id="prev-2">Précédent</button>
      <button type="button" id="next-2">Suivant</button>
    </div>
  </div>
  <!-- Étape 3 -->
  <div class="form-step" id="step-3">
    <h3>Souhaitez-vous des options supplémentaires ?</h3>
    <div class="radio-group">
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Tuning hydraulique"> Tuning hydraulique (+59€)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Le tuning hydraulique est une modification des clapets des fourches de vélo qui est crucial pour optimiser les performances de la suspension avant, offrant ainsi une meilleure expérience de conduite, une meilleure traction, et un meilleur contrôle sur divers terrains. </span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Tuning Team CFR joints spi SKF"> Tuning Team CFR joints spi SKF (+19,90€)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Roulez comme les pros grâce aux joints spi SKF verts.
Tuning utilisé par la Team Cannondale Factory Racing.

Ce tuning vous permet la réduction des frictions et donc une meilleure sensibilité de la fourche et un fonctionnement plus fluide.

Il offre une meilleure étanchéité préservant ainsi l’huile et les joints internes.

La conception SKF permet une usure plus homogène, prolongeant la durée de vie des joints et réduisant la nécessité d’entretien fréquent.</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Modification sens du blocage"> Modification sens du blocage (+78€)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">La modification du sens de blocage permet de modifier la position bloquée de votre fourche.

si elle est « fermée par défaut«  au repos, on passe à une position « ouvert par défaut«  au repos, grâce au changement du clapet de blocage qui se trouve à l’intérieur du piston de compression.

En terme de prévention, il est utile de passer par ce système car en cas de casse de votre manette de blocage, votre fourche sera toujours utilisable pour finir votre sortie ou votre course. 

Il n’est pas possible de faire cette modification sur les Scalpel équipés de doubles commandes.</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Blocage sur cintre"> Blocage sur cintre (+157€)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Remplacement du levier de blocage par une manette de blocage au niveau du cintre.
Permet une meilleure accessibilité, une manipulation plus aisée car gain de temps et économie d’energie dans des situations compétitives ou lors de sorties avec des parcours techniques.</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Modification du débattement"> Modification du débattement (+149€)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Permet d’avoir un plus grand débattement pour une conduite plus confortable et absorbante des chocs.

Sa modification peut influencer les performances : une meilleure stabitlité et une meileure maniabilité.</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Fourreau carbone"> Fourreau carbone (+399€)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Remplacement du fourreau aluminium par un fourreau carbone

Il permet :

– une réduction de poids (-320 grammes) qui allègue le vélo et offre une meilleure vivacité 

– une meilleure absorption des vibrations qui améliorera le contrôle et le confort de conduite

– meilleure rigidité qui améliore la direction et la réactivité du vélo</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Modification 650 en 700"> Modification 650 en 700 (+159€)
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Si vous achetez une Lefty Ocho Oliver sur notre site <a href="https://110cannondale.com">110cannondale.com</a>, cette modification sera faite sans frais supplémentaires. Cette modification vous permet de passer d’une Lefty Ocho Oliver prévue avec une roue de 650 à une roue de 700.

Une plus grande roue vous permet d’avoir une meilleure stabilité.</span>
        </span>
      </label>
      <label class="radio-btn" style="position:relative;">
        <input type="checkbox" name="usage[]" value="Sans option"> Sans option
        <span class="info-toggle" style="margin-left:6px;cursor:pointer;display:inline-block;width:18px;height:18px;border-radius:50%;background:#FF3F22;color:#fff;text-align:center;line-height:18px;font-weight:medium;position:relative;" tabindex="0">?
            <span class="info-dialogue" style="display:none;position:absolute;left:24px;top:-8px;z-index:10;background:#fff;border:1px solid #FF3F22;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);color:#222;min-width:220px;font-size:0.98em;">Aucune option supplémentaire sélectionnée.</span>
        </span>
      </label>

    </div>
    <div class="form-pagination">
      <button type="button" id="prev-3">Précédent</button>
      <button type="button" id="next-3">Suivant</button>
    </div>
  </div>
  <!-- Étape 4 : Inputs -->
  <div class="form-step" id="step-4">
    <h3>Informations complémentaires</h3>
    <div style="margin-bottom:18px;">
      <label for="date-revision" style="font-weight:600;display:block;margin-bottom:6px;">Date de la dernière révision</label>
      <input type="date" id="date-revision" name="date_revision" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:320px;">
    </div>
    <div style="margin-bottom:18px;">
      <label for="poids-pilote" style="font-weight:600;display:block;margin-bottom:6px;">Poids du pilote (kg)</label>
      <input type="number" id="poids-pilote" name="poids_pilote" min="0" step="1" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:180px;">
    </div>
    <div style="margin-bottom:18px;">
      <label style="font-weight:600;display:block;margin-bottom:6px;">Modèle et année du vélo</label>
      <div style="display:flex;gap:12px;align-items:center;">
        <input type="text" id="modele-velo" name="modele_velo" placeholder="Modèle" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:200px;">
        <input type="text" id="annee-velo" name="annee_velo" placeholder="Année" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:120px;">
      </div>
    </div>
    <div style="margin-bottom:18px;">
      <label for="remarques" style="font-weight:600;display:block;margin-bottom:6px;">Remarques</label>
      <textarea id="remarques" name="remarques" rows="3" style="width:100%;max-width:420px;padding:8px 12px;border-radius:6px;border:1px solid #ccc;"></textarea>
    </div>
    <div style="margin-bottom:18px;">
      <label for="fichier" style="font-weight:600;display:block;margin-bottom:6px;">Joindre un document</label>
      <input type="file" id="fichier" name="fichier" style="padding:8px 0;">
      <input type="hidden" name="url" value="<?php echo home_url( add_query_arg( null, null ) ); ?>">
    </div>
    <div class="form-pagination">
      <button type="button" id="prev-4">Précédent</button>
      <button type="button" id="next-4">Suivant</button>
    </div>
  </div>
  <!-- Étape 5 : Résumé -->
  <div class="form-step" id="step-5">
    <h3>Résumé de votre demande</h3>
    <div id="resume-content" style="margin-bottom:18px;"></div>
    <div class="form-pagination">
      <button type="button" id="prev-5">Précédent</button>
      <button type="submit">Envoyer</button>
    </div>
  </div>
  <div id="form-result" style="margin-top:20px; color:green;"></div>
</form>
<script>
// Info dialogue toggle
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.info-toggle').forEach(function(toggle) {
    const dialogue = toggle.querySelector('.info-dialogue');
    toggle.addEventListener('mouseenter', function() {
      dialogue.style.display = 'block';
    });
    toggle.addEventListener('mouseleave', function() {
      dialogue.style.display = 'none';
    });
    toggle.addEventListener('focus', function() {
      dialogue.style.display = 'block';
    });
    toggle.addEventListener('blur', function() {
      dialogue.style.display = 'none';
    });
  });
});
const steps = [
  document.getElementById('step-1'),
  document.getElementById('step-2'),
  document.getElementById('step-3'),
  document.getElementById('step-4'),
  document.getElementById('step-5')
];
let currentStep = 0;
function showStep(index) {
  steps.forEach((step, i) => step.classList.toggle('active', i === index));
  updateProgressBar(index);
  // Focus sur le formulaire pour le centrer à chaque changement d'étape
  const form = document.getElementById('multi-step-form');
  if(form) {
    form.scrollIntoView({behavior: 'smooth', block: 'center'});
  }
}
function updateProgressBar(index) {
  // 4 étapes de questions, la 5e est le résumé
  const totalSteps = 4;
  let stepNum = index + 1;
  if (stepNum > totalSteps) stepNum = totalSteps;
  document.getElementById('progress-step').textContent = stepNum > totalSteps ? totalSteps : stepNum;
  const percent = Math.round((stepNum-1) / totalSteps * 100);
  document.getElementById('progress-bar').style.width = percent + '%';
}
function updateNextButtonState(step, radioName, nextBtnId) {
  const radios = document.getElementsByName(radioName);
  const nextBtn = document.getElementById(nextBtnId);
  function check() {
    let checked = false;
    radios.forEach ? radios.forEach(r => { if(r.checked) checked = true; }) : Array.from(radios).forEach(r => { if(r.checked) checked = true; });
    if (checked) {
      nextBtn.classList.remove('button-disabled');
      nextBtn.disabled = false;
    } else {
      nextBtn.classList.add('button-disabled');
      nextBtn.disabled = true;
    }
  }
  radios.forEach ? radios.forEach(r => r.addEventListener('change', check)) : Array.from(radios).forEach(r => r.addEventListener('change', check));
  check();
}
function updateNext2ButtonState() {
  const dateVal = document.getElementById('date-revision').value;
  const poidsVal = document.getElementById('poids-pilote').value;
  const modeleVal = document.getElementById('modele-annee').value;
  const remarquesVal = document.getElementById('remarques').value;
  const nextBtn = document.getElementById('next-2');
  if(dateVal && poidsVal && modeleVal && remarquesVal) {
    nextBtn.classList.remove('button-disabled');
    nextBtn.disabled = false;
  } else {
    nextBtn.classList.add('button-disabled');
    nextBtn.disabled = true;
  }
}
function updateRadioSelected() {
  document.querySelectorAll('.radio-group').forEach(group => {
    group.querySelectorAll('.radio-btn').forEach(label => {
      const input = label.querySelector('input');
      input.addEventListener('change', function() {
        if(input.type === 'radio') {
          group.querySelectorAll('.radio-btn').forEach(l => l.classList.remove('selected'));
          if(input.checked) label.classList.add('selected');
        } else {
          if(input.checked) label.classList.add('selected');
          else label.classList.remove('selected');
        }
      });
      if(input.checked) label.classList.add('selected');
      else label.classList.remove('selected');
    });
  });
}
document.addEventListener('DOMContentLoaded', function() {
  updateNextButtonState('step-1', 'type_fourche', 'next-1');
  // Pour les prestations (checkboxes), on active le bouton suivant si au moins une est cochée
  function updateNext2ButtonState() {
    const checkboxes = document.querySelectorAll('input[name="prestations[]"]');
    const nextBtn = document.getElementById('next-2');
    let checked = false;
    checkboxes.forEach(cb => { if(cb.checked) checked = true; });
    if (checked) {
      nextBtn.classList.remove('button-disabled');
      nextBtn.disabled = false;
    } else {
      nextBtn.classList.add('button-disabled');
      nextBtn.disabled = true;
    }
  }
  document.querySelectorAll('input[name="prestations[]"]').forEach(cb => cb.addEventListener('change', updateNext2ButtonState));
  updateNext2ButtonState();
  // Pour les checkboxes, on active le bouton suivant si au moins une est cochée
  function updateNext3ButtonState() {
    const checkboxes = document.querySelectorAll('input[name="usage[]"]');
    const nextBtn = document.getElementById('next-3');
    let checked = false;
    checkboxes.forEach(cb => { if(cb.checked) checked = true; });
    if (checked) {
      nextBtn.classList.remove('button-disabled');
      nextBtn.disabled = false;
    } else {
      nextBtn.classList.add('button-disabled');
      nextBtn.disabled = true;
    }
  }
  document.querySelectorAll('input[name="usage[]"]').forEach(cb => cb.addEventListener('change', updateNext3ButtonState));
  updateNext3ButtonState();
  // Étape 4 : inputs
  function updateNext4ButtonState() {
    const dateVal = document.getElementById('date-revision').value;
    const poidsVal = document.getElementById('poids-pilote').value;
    const modeleVal = document.getElementById('modele-velo').value;
    const anneeVal = document.getElementById('annee-velo').value;
    const remarquesVal = document.getElementById('remarques').value;
    const nextBtn = document.getElementById('next-4');
    if(dateVal && poidsVal && modeleVal && anneeVal && remarquesVal) {
      nextBtn.classList.remove('button-disabled');
      nextBtn.disabled = false;
    } else {
      nextBtn.classList.add('button-disabled');
      nextBtn.disabled = true;
    }
  }
  ['date-revision','poids-pilote','modele-velo','annee-velo','remarques'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateNext4ButtonState);
  });
  updateNext4ButtonState();
  updateRadioSelected();
  updateProgressBar(0);
});
document.querySelectorAll('input[type="radio"]').forEach(input => {
  input.addEventListener('change', updateRadioSelected);
});
document.getElementById('next-1').onclick = function() {
  if(document.querySelector('input[name="type_fourche"]:checked')) {
    currentStep = 1; showStep(currentStep);
  }
};
document.getElementById('prev-2').onclick = function() {
  currentStep = 0; showStep(currentStep);
};
document.getElementById('next-2').onclick = function() {
  const checkedPrestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked'));
  if(checkedPrestations.length === 0) {
    checkedPrestations[0]?.focus();
    return;
  }
  currentStep = 2; showStep(currentStep);
};
document.getElementById('prev-3').onclick = function() {
  currentStep = 1;
  showStep(currentStep);
};
document.getElementById('next-3').onclick = function() {
  const checkedUsages = Array.from(document.querySelectorAll('input[name="usage[]"]:checked'));
  if(checkedUsages.length === 0) {
    checkedUsages[0]?.focus();
    return;
  }
  currentStep = 3;
  showStep(currentStep);
};
document.getElementById('prev-4').onclick = function() {
  currentStep = 2; showStep(currentStep);
};
document.getElementById('next-4').onclick = function() {
  // Validation : tous les champs obligatoires
  const dateVal = document.getElementById('date-revision').value;
  const poidsVal = document.getElementById('poids-pilote').value;
  const modeleVal = document.getElementById('modele-velo').value;
  const anneeVal = document.getElementById('annee-velo').value;
  const remarquesVal = document.getElementById('remarques').value;
  if(!dateVal || !poidsVal || !modeleVal || !anneeVal || !remarquesVal) {
    if(!dateVal) document.getElementById('date-revision').focus();
    else if(!poidsVal) document.getElementById('poids-pilote').focus();
    else if(!modeleVal) document.getElementById('modele-velo').focus();
    else if(!anneeVal) document.getElementById('annee-velo').focus();
    else document.getElementById('remarques').focus();
    return;
  }
  // Afficher le résumé
  const type_fourche = document.querySelector('input[name="type_fourche"]:checked')?.value;
  const prestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked')).map(cb => cb.value).join(', ');
  const usages = Array.from(document.querySelectorAll('input[name="usage[]"]:checked')).map(cb => cb.value).join(', ');
  const date_revision = document.getElementById('date-revision').value;
  const poids_pilote = document.getElementById('poids-pilote').value;
  const modele_velo = document.getElementById('modele-velo').value;
  const annee_velo = document.getElementById('annee-velo').value;
  const modele_annee = `${modele_velo} (${annee_velo})`;
  const remarques = document.getElementById('remarques').value;
  const fichier = document.getElementById('fichier').files[0];
  let fileName = fichier ? fichier.name : 'Aucun';
  document.getElementById('resume-content').innerHTML = `<strong>Type de fourche :</strong> ${type_fourche}<br><strong>Prestations :</strong> ${prestations}<br><strong>Options :</strong> ${usages}<br><strong>Date de la dernière révision :</strong> ${date_revision}<br><strong>Poids du pilote :</strong> ${poids_pilote} kg<br><strong>Modèle et année du vélo :</strong> ${modele_annee}<br><strong>Remarques :</strong> ${remarques}<br><strong>Fichier joint :</strong> ${fileName}`;
    currentStep = 4; showStep(currentStep);
};
document.getElementById('multi-step-form').onsubmit = function(e) {
  e.preventDefault();
  const type_fourche = document.querySelector('input[name="type_fourche"]:checked')?.value;
  const prestations = Array.from(document.querySelectorAll('input[name="prestations[]"]:checked')).map(cb => cb.value);
  const usages = Array.from(document.querySelectorAll('input[name="usage[]"]:checked')).map(cb => cb.value);
  const date_revision = document.getElementById('date-revision').value;
  const poids_pilote = document.getElementById('poids-pilote').value;
  const modele_velo = document.getElementById('modele-velo').value;
  const annee_velo = document.getElementById('annee-velo').value;
  const modele_annee = `${modele_velo} (${annee_velo})`;
  const remarques = document.getElementById('remarques').value;
  const fichier = document.getElementById('fichier').files[0];
  var formData = new FormData();
  formData.append('type_fourche', type_fourche);
  prestations.forEach(p => formData.append('prestations[]', p));
  usages.forEach(u => formData.append('usage[]', u));
  formData.append('date_revision', date_revision);
  formData.append('poids_pilote', poids_pilote);
  formData.append('modele_annee', modele_annee);
  formData.append('remarques', remarques);
  if(fichier) formData.append('fichier', fichier);
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/wp-admin/admin-ajax.php?action=envoyer_form_fourche', true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      document.getElementById('form-result').textContent = 'Formulaire envoyé avec succès !';
      document.getElementById('multi-step-form').reset();
      showStep(0);
      updateNextButtonState('step-1', 'type_fourche', 'next-1');
      updateNext2ButtonState();
      updateNext3ButtonState();
      updateNext4ButtonState();
      updateRadioSelected();
      updateProgressBar(0);
    } else {
      document.getElementById('form-result').textContent = 'Erreur lors de l’envoi.';
    }
  };
  xhr.send(formData);
};
</script>
<?php else : ?>
<div style="text-align:center; margin:40px 0;">
  <p style="font-size:1.2em; font-weight:600;">Vous devez être connecté pour accéder au formulaire.</p>
  <a href="<?php echo wp_login_url(); ?>" class="button" style="background:#FF3F22;color:#fff;padding:12px 32px;border-radius:8px;font-weight:600;text-decoration:none;">Se connecter</a>
</div>
<?php endif; ?>
